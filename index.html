<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yetta以她小手机</title>
    <!-- 1. 引入外部的CSS样式文件 -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="phone">
    <div class="success-modal" id="successModal">
        <div class="modal-content">
            <h3 id="successModalTitle">操作成功</h3>
            <p id="successModalMessage">你的设置已保存。</p>
        </div>
    </div>
    <div class="screen" id="screen">
        <div class="avatar-action-sheet" id="locationActionSheet">
            <div class="action-sheet-backdrop" onclick="closeLocationChooser()"></div>
            <div class="action-sheet-options">
                <div class="action-option" onclick="selectRealLocation()">📍 获取真实地址</div>
                <div class="action-option" onclick="selectVirtualLocation()">✏️ 填写虚拟地址</div>
            </div>
            <div class="action-sheet-options" style="margin-top: 0;">
                <div class="action-option cancel" onclick="closeLocationChooser()">取消</div>
            </div>
        </div>
        <div class="pages-wrapper" id="pagesWrapper">
            <div class="page" id="page1">
                <div class="status-bar">
                    <span>19:05</span>
                    <div class="status-icons">
                        <svg class="status-icon-svg" viewBox="0 0 24 24">
                            <path fill-rule="evenodd"
                                  d="M12 4.5C7.31 4.5 3.19 6.84 1.33 10.33l1.83.92C4.69 8.23 8.01 6.5 12 6.5s7.31 1.73 8.84 4.75l1.83-.92C20.81 6.84 16.69 4.5 12 4.5zM12 9.5c-3.31 0-6.13 1.5-7.58 3.82l1.83.91C7.43 12.19 9.53 11.5 12 11.5s4.57.69 5.75 2.73l1.83-.91C18.13 11 15.31 9.5 12 9.5zM12 14.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5z"></path>
                        </svg>
                        <div class="battery-container">
                            <div class="battery-icon">
                                <svg viewBox="0 0 26 14" fill="none">
                                    <path d="M24 4.33333V9.66667C25.1046 9.66667 26 8.77123 26 7.66667C26 6.5621 25.1046 5.66667 24 5.66667V4.33333Z"
                                          fill="currentColor"></path>
                                    <path d="M1 4.66667C1 3.19391 2.19391 2 3.66667 2H20.3333C21.8061 2 23 3.19391 23 4.66667V9.33333C23 10.8061 21.8061 12 20.3333 12H3.66667C2.19391 12 1 10.8061 1 9.33333V4.66667Z"
                                          stroke="currentColor" stroke-width="2"></path>
                                </svg>
                                <div class="battery-level"></div>
                                <svg class="charging-bolt" viewBox="0 0 24 24">
                                    <path d="M11 21v-8H7l5-10v8h4l-5 10z"></path>
                                </svg>
                            </div>
                            <span class="battery-text">100%</span>
                        </div>
                    </div>
                </div>

                <div class="time-weather-section">
                    <div class="time-card" id="timeCard">
                        <!-- 背景层保持不变 -->
                        <div class="card-background-wrapper">
                            <div class="top-gingham-bg"></div>
                            <div class="bottom-stripes-bg"></div>
                            <div class="drip-divider"></div>
                        </div>
                        <div class="delete-time-btn" onclick="deleteTimeCard()">×</div>

                        <!-- === 最终版时间内容容器 开始 === -->
                        <!-- 新增一个.whiskers-bg层，用于放置胡须和新的棕色背景 -->
                        <div class="whiskers-bg">
                            <div class="final-time-container">
                                <h2 id="finalMainTime">19:05</h2>
                                <div id="finalMainDate" class="day">TUESDAY, MAR 21</div>
                            </div>
                        </div>
                        <!-- === 最终版时间内容容器 结束 === -->
                    </div>

                    <div class="weather-card" id="weatherCard">
                        <!-- 新增：背景包裹层 -->
                        <div class="card-background-wrapper">
                            <div class="top-gingham-bg"></div>      <!-- 用于上半部分的格子背景 -->
                            <div class="bottom-stripes-bg"></div> <!-- 用于下半部分的条纹背景 -->
                            <div class="drip-divider"></div>      <!-- 用于中间的波浪分割线 -->
                        </div>

                        <div class="delete-weather-btn" onclick="deleteWeatherCard()">×</div>

                        <!-- 原有内容保持不变，它们会显示在新背景之上 -->
                        <div class="top-row">
                            <div class="location-display" onclick="openLocationChooser()">
                                <span class="location-icon">📍</span>
                                <span class="location-text" id="locationText">越秀区</span>
                            </div>
                            <div class="weather-display" onclick="toggleWeatherSelector(event)">
                                <span class="current-weather-icon" id="currentWeatherIcon">☀️</span>
                            </div>
                        </div>

                        <div class="mood-section" onclick="editMood(event)">
                            <div class="mood-label">今日心情</div>
                            <div class="mood-text" id="moodText">心情怎样呢？</div> <!-- 我把心情改成了“坏”以匹配你的截图 -->
                        </div>

                        <div class="weather-popup" id="weatherPopup" style="display: none;">
                            <div class="weather-popup-title">选择天气</div>
                            <div class="weather-options">
                                    <span class="weather-option active" data-weather="sunny"
                                          onclick="selectWeather('sunny', event)">☀️</span>
                                <span class="weather-option" data-weather="cloudy"
                                      onclick="selectWeather('cloudy', event)">☁️</span>
                                <span class="weather-option" data-weather="rainy"
                                      onclick="selectWeather('rainy', event)">🌧️</span>
                                <span class="weather-option" data-weather="snowy"
                                      onclick="selectWeather('snowy', event)">❄️</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="avatar-action-sheet" id="avatarActionSheet">
                    <div class="action-sheet-backdrop" onclick="closeAvatarActions()"></div>
                    <div class="action-sheet-options">
                        <div class="action-option" onclick="promptForUrl()">从 URL 填写</div>
                        <div class="action-option" onclick="triggerFileUpload()">从文件选择</div>
                    </div>
                    <div class="action-sheet-options" style="margin-top: 0;">
                        <div class="action-option cancel" onclick="closeAvatarActions()">取消</div>
                    </div>
                </div>

                <div class="grid-container" id="grid1"></div>
            </div>

            <div class="page" id="page2">
                <div class="status-bar">
                    <span>19:05</span>
                    <div class="status-icons">
                        <svg class="status-icon-svg" viewBox="0 0 24 24">
                            <path fill-rule="evenodd"
                                  d="M12 4.5C7.31 4.5 3.19 6.84 1.33 10.33l1.83.92C4.69 8.23 8.01 6.5 12 6.5s7.31 1.73 8.84 4.75l1.83-.92C20.81 6.84 16.69 4.5 12 4.5zM12 9.5c-3.31 0-6.13 1.5-7.58 3.82l1.83.91C7.43 12.19 9.53 11.5 12 11.5s4.57.69 5.75 2.73l1.83-.91C18.13 11 15.31 9.5 12 9.5zM12 14.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5z"></path>
                        </svg>
                        <div class="battery-container">
                            <div class="battery-icon">
                                <svg viewBox="0 0 26 14" fill="none">
                                    <path d="M24 4.33333V9.66667C25.1046 9.66667 26 8.77123 26 7.66667C26 6.5621 25.1046 5.66667 24 5.66667V4.33333Z"
                                          fill="currentColor"></path>
                                    <path d="M1 4.66667C1 3.19391 2.19391 2 3.66667 2H20.3333C21.8061 2 23 3.19391 23 4.66667V9.33333C23 10.8061 21.8061 12 20.3333 12H3.66667C2.19391 12 1 10.8061 1 9.33333V4.66667Z"
                                          stroke="currentColor" stroke-width="2"></path>
                                </svg>
                                <div class="battery-level"></div>
                                <svg class="charging-bolt" viewBox="0 0 24 24">
                                    <path d="M11 21v-8H7l5-10v8h4l-5 10z"></path>
                                </svg>
                            </div>
                            <span class="battery-text">100%</span>
                        </div>
                    </div>
                </div>

                <div class="grid-container" id="grid2"></div>
            </div>
        </div>

        <div class="edit-hint" id="editHint1">长按图标可以拖动调整位置</div>
        <div class="edit-hint" id="editHint2">长按图标可以拖动调整位置</div>

        <div class="page-dots">
            <div class="dot active" onclick="showPage(1)"></div>
            <div class="dot" onclick="showPage(2)"></div>
        </div>

        <div class="dock">
            <!-- 图标将由JavaScript动态生成到这里 -->
        </div>

        <div class="settings-page" id="settingsPage">
            <div class="settings-header">
                <div class="back-btn" onclick="closeSettings()">←</div>
                <div class="settings-title">设置</div>
            </div>

            <div class="settings-content">
                <div class="settings-section">
                    <div class="section-title">配置</div>
                    <div class="settings-item" onclick="openApiConfig()">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">🔌
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">API设置</div>
                            <div class="settings-desc">管理API配置和模型</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item" onclick="openConfig('database')">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">🗄️
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">数据库设置</div>
                            <div class="settings-desc">配置Supabase数据库</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #89f7fe, #66a6ff);">📱
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">全屏模式</div>
                            <div class="settings-desc">移除手机边框，享受沉浸式体验</div>
                        </div>
                        <div class="settings-action">
                            <label class="toggle-switch">
                                <input type="checkbox" id="fullscreenToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item" onclick="openConfig('storage')">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">☁️
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">云存储设置</div>
                            <div class="settings-desc">配置Supabase Storage</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item" onclick="openBeautify()">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #ff9a9e, #fecfef);">🎨
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">美化</div>
                            <div class="settings-desc">自定义应用图标</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item" onclick="openWidgetManager()">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">📦
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">组件</div>
                            <div class="settings-desc">自定义桌面组件</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #ff9a9e, #fecfef);">🐾
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">悬浮球</div>
                            <div class="settings-desc">在主屏幕显示一个快捷操作悬浮球</div>
                        </div>
                        <div class="settings-action">
                            <label class="toggle-switch">
                                <input type="checkbox" id="floatingBallToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="section-title">危险区域</div>
                        <div class="settings-item" onclick="clearAllData()">
                            <div class="settings-icon" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">
                                🗑️
                            </div>
                            <div class="settings-info">
                                <div class="settings-label" style="color: #ff3b30;">清空所有数据</div>
                                <div class="settings-desc">将删除所有设置、联系人、聊天记录和自定义内容</div>
                            </div>
                            <div class="settings-arrow">›</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="config-page" id="apiConfig">
            <div class="settings-header">
                <div class="back-btn" onclick="closeApiConfig()">←</div>
                <div class="settings-title">API配置</div>
            </div>
            <div class="settings-content">
                <div class="section-title">已保存的配置</div>
                <div class="api-config-list" id="apiConfigList"></div>

                <div class="settings-section">
                    <div class="form-group">
                        <label class="form-label">配置名称</label>
                        <input type="text" class="form-input" id="configName" placeholder="例如: OpenAI GPT-4">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API URL</label>
                        <input type="text" class="form-input" id="apiUrl" placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="apiKey" placeholder="sk-...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">选择模型</label>
                        <select class="form-select" id="modelSelect">
                            <option value="">请先拉取模型列表</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="test-btn" onclick="testConnection()">测试连接</button>
                    <button class="fetch-btn" onclick="fetchModels()">拉取模型</button>
                </div>
                <div class="btn-group">
                    <button class="save-btn" onclick="saveApiConfig()">保存配置</button>
                </div>
                <div id="apiStatus" style="margin: 0 20px; font-size: 12px; color: #28a745; font-weight: 600;"></div>
            </div>
        </div>

        <div class="config-page" id="databaseConfig">
            <div class="settings-header">
                <div class="back-btn" onclick="closeConfig('database')">←</div>
                <div class="settings-title">数据库设置</div>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="form-group">
                        <label class="form-label">Supabase URL</label>
                        <input type="text" class="form-input" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Supabase Anon Key</label>
                        <input type="password" class="form-input" id="supabaseKey" placeholder="输入你的匿名密钥">
                    </div>
                    <div class="form-group">
                        <label class="form-label">表名称</label>
                        <input type="text" class="form-input" id="tableName" placeholder="例如: user_data"
                               value="user_data">
                    </div>
                </div>
                <button class="save-btn" onclick="saveConfig('database')" style="margin: 20px;">保存并初始化</button>
                <div id="dbStatus" style="margin: 0 20px; font-size: 12px; color: #28a745; font-weight: 600;"></div>
            </div>
        </div>

        <div class="config-page" id="storageConfig">
            <div class="settings-header">
                <div class="back-btn" onclick="closeConfig('storage')">←</div>
                <div class="settings-title">云存储设置</div>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="form-group">
                        <label class="form-label">Storage Bucket名称</label>
                        <input type="text" class="form-input" id="bucketName" placeholder="例如: icons" value="icons">
                    </div>
                    <div class="form-group">
                        <label class="form-label">文件上传路径</label>
                        <input type="text" class="form-input" id="uploadPath" placeholder="例如: app-icons/"
                               value="app-icons/">
                    </div>
                    <div class="form-group">
                        <label class="form-label">最大文件大小 (MB)</label>
                        <input type="number" class="form-input" id="maxFileSize" placeholder="5" value="5">
                    </div>
                </div>
                <button class="save-btn" onclick="saveConfig('storage')" style="margin: 20px;">保存配置</button>
                <div id="storageStatus"
                     style="margin: 0 20px; font-size: 12px; color: #28a745; font-weight: 600;"></div>
            </div>
        </div>

        <div class="beautify-page" id="beautifyPage">
            <div class="settings-header">
                <div class="back-btn" onclick="closeBeautify()">←</div>
                <div class="settings-title">美化</div>
            </div>
            <div class="settings-content">

                <div class="settings-section">
                    <div class="section-title">更换壁纸</div>
                    <div class="wallpaper-grid" id="wallpaperGrid">
                    </div>
                </div>
                <div class="settings-section" style="padding: 0 12px; margin-top: -8px;">
                    <div class="app-preview-item">
                        <div class="preview-header">
                            <div class="preview-icon">🖼️</div>
                            <div class="preview-name">自定义壁纸</div>
                        </div>
                        <div class="upload-section">
                            <label class="upload-btn">
                                📁 上传文件
                                <input type="file" class="file-input" accept="image/*"
                                       onchange="handleWallpaperUpload(event)">
                            </label>
                            <div class="url-input-btn" onclick="toggleWallpaperUrlInput()">🔗 URL填写</div>
                        </div>
                        <div class="url-input-box" id="wallpaper-url-box">
                            <input type="text" class="url-input-field" id="wallpaper-url-input"
                                   placeholder="输入图片URL">
                            <button class="confirm-btn" onclick="applyWallpaperFromUrl()">确认</button>
                        </div>
                        <div class="status-message" id="wallpaper-status"></div>
                    </div>
                </div>
                <div class="app-preview-list" id="appPreviewList">
                </div>
            </div>
        </div>
        <div class="config-page" id="widgetManager">
            <div class="settings-header">
                <div class="back-btn" onclick="closeWidgetManager()">←</div>
                <div class="settings-title">组件管理</div>
            </div>

            <div class="settings-content">
                <div class="section-title">自定义组件代码</div>

                <div style="padding: 0 20px;">
                    <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px; font-weight: 600;">
                            组件HTML代码
                        </div>
                        <textarea id="widgetCodeInput"
                                  style="width: 100%; min-height: 200px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; resize: vertical;"
                                  placeholder="示例代码：<div class='widget-scene'>
                            <div style='position: absolute; bottom: 20px; right: 30px; font-size: 60px;'>🌺</div>
                            </div>

                            可用CSS选择器：
                            .widget - 组件容器
                            .widget-time - 顶部文字
                            .widget-scene - 场景区域
                            支持常见CSS样式"></textarea>
                    </div>
                    <button class="save-btn" onclick="applyCustomWidget()"
                            style="width: 100%; margin-bottom: 16px;">应用组件
                    </button>
                </div>
            </div>
            <div class="section-title">已有组件</div>
            <div id="savedWidgetsList" style="padding: 0 20px;"></div>
        </div>

        <!-- ========== 新增：文件夹浮层 ========== -->
        <div class="folder-overlay" id="folderOverlay" onclick="closeFolder()">
            <div class="folder-modal" onclick="event.stopPropagation()">
                <div class="folder-header">
                    <h3 id="folderName">文件夹名称</h3>
                    <input type="text" id="folderNameInput" style="display: none;">
                </div>
                <div class="folder-grid-container" id="folderContentGrid">
                    <!-- 文件夹内的图标将由JS动态生成到这里 -->
                </div>
            </div>
        </div>
        <div class="contacts-page" id="contactsPage">
            <div class="contacts-header">
                <div class="back-btn" onclick="closeContacts()">←</div>
                <input type="text" class="contacts-search" id="contactsSearch" placeholder="搜索联系人..."
                       oninput="filterContacts()">
                <div class="add-contact-btn" onclick="toggleContactMenu(event)">+</div>

                <div class="contact-menu" id="contactMenu">
                    <div class="contact-menu-item" onclick="createNewContact()">新建联系人</div>
                    <div class="contact-menu-item" onclick="selectExistingContact()">选择已有联系人</div>
                </div>
            </div>
            <div class="contacts-list" id="contactsList"></div>
        </div>
        <div class="modal-overlay" id="characterCardModal">
            <div class="character-card-modal">
                <div class="character-card-content">
                    <!-- ========= 对方（联系人）信息区 ========= -->
                    <div class="top-info-section">
                        <!-- 左侧：头像 -->
                        <div class="character-avatar" onclick="openAvatarActions('contact')">
                            <img id="avatar-preview" src="" alt="角色头像">
                        </div>

                        <!-- 右侧：核心信息 -->
                        <div class="core-details">
                            <input type="text" id="char-name" placeholder="角色姓名">
                            <div class="character-gender-selection">
                                <label><input type="radio" name="char-gender" value="male" checked> 男</label>
                                <label><input type="radio" name="char-gender" value="female"> 女</label>
                                <label><input type="radio" name="char-gender" value="other"> 其他</label>
                            </div>
                        </div>
                    </div>
                    <div class="persona-section">
                        <textarea id="char-persona" placeholder="在此处填写角色的背景故事..."></textarea>
                    </div>
                    <div class="character-worldbook-section">
                        <div class="char-wb-toggle" onclick="toggleCharacterWorldbooks()">
                            <div class="char-wb-toggle-label">📚 绑定的世界书</div>
                            <span class="char-wb-toggle-arrow" id="char-wb-arrow">▼</span>
                        </div>
                        <div class="char-wb-list" id="charWorldbooksList" style="display: none;">
                            <!-- 世界书复选框将由JS动态生成到这里 -->
                        </div>
                    </div>
                    <div class="card-divider">
                        <span class="divider-text">我的信息</span>
                    </div>
                    <!-- ========= 我（用户）信息区 ========= -->
                    <div class="top-info-section">
                        <div class="character-avatar" onclick="openAvatarActions('user')">
                            <img id="user-avatar-preview" src="" alt="我的头像">
                        </div>
                        <div class="core-details">
                            <input type="text" id="user-name" placeholder="我的昵称">
                        </div>
                    </div>
                    <div class="persona-section">
                        <!-- 新增：用户的设定输入框 -->
                        <textarea id="user-persona"
                                  placeholder="在此处填写“我的设定”，将作为系统提示词..."></textarea>
                    </div>

                    <!-- 隐藏的文件上传输入框（保持不变） -->
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                </div>

                <div class="character-card-footer">
                    <button class="character-card-btn cancel" onclick="closeCharacterCardPage()">取消</button>
                    <button class="character-card-btn save" onclick="saveAllCharacterData()">保存</button>
                </div>
            </div>
        </div>
        <!-- ========== 新增：密友专用角色卡弹窗 ========== -->
        <div class="modal-overlay" id="sweetheartCardModal">
            <div class="sweetheart-card-modal">
                <!-- 顶部装饰条 -->
                <div class="sweetheart-card-header">
                    <span class="header-deco">🌸</span>
                    <span class="header-title">添加密友</span>
                    <span class="header-deco">🌸</span>
                </div>

                <div class="sweetheart-card-content">
                    <!-- 头像区域 -->
                    <div class="sweetheart-avatar-section">
                        <div class="sweetheart-avatar" onclick="openSweetheartAvatarPicker()">
                            <img id="sweetheart-avatar-preview" src="" alt="头像">
                            <div class="avatar-overlay">
                                <span>📷</span>
                            </div>
                        </div>
                    </div>
                    <!-- 姓名（必填） -->
                    <div class="sweetheart-field required-field">
                        <label class="sweetheart-label">
                            <span class="label-icon">💕</span>
                            <span class="label-text">姓名</span>
                            <span class="required-star">*</span>
                        </label>
                        <input type="text" id="sweetheart-name" class="sweetheart-input" placeholder="TA叫什么呢...">
                    </div>
                    <!-- 基础设定（必填） -->
                    <div class="sweetheart-field required-field">
                        <label class="sweetheart-label">
                            <span class="label-icon">📝</span>
                            <span class="label-text">基础设定</span>
                            <span class="required-star">*</span>
                        </label>
                        <textarea id="sweetheart-persona" class="sweetheart-textarea" placeholder="描述TA的基本特点..."
                                  rows="3"></textarea>
                    </div>
                    <!-- 性格（可选） -->
                    <div class="sweetheart-field">
                        <label class="sweetheart-label">
                            <span class="label-icon">✨</span>
                            <span class="label-text">性格</span>
                        </label>
                        <input type="text" id="sweetheart-personality" class="sweetheart-input"
                               placeholder="温柔、活泼、冷静...">
                    </div>
                    <!-- 职业（可选） -->
                    <div class="sweetheart-field">
                        <label class="sweetheart-label">
                            <span class="label-icon">💼</span>
                            <span class="label-text">职业</span>
                        </label>
                        <input type="text" id="sweetheart-occupation" class="sweetheart-input"
                               placeholder="学生、教师、医生...">
                    </div>
                    <!-- 口头禅（可选） -->
                    <div class="sweetheart-field">
                        <label class="sweetheart-label">
                            <span class="label-icon">💬</span>
                            <span class="label-text">口头禅</span>
                        </label>
                        <input type="text" id="sweetheart-catchphrase" class="sweetheart-input"
                               placeholder="TA常说的话...">
                    </div>
                    <!-- 过去的经历（可选） -->
                    <div class="sweetheart-field">
                        <label class="sweetheart-label">
                            <span class="label-icon">📖</span>
                            <span class="label-text">过去的经历</span>
                        </label>
                        <textarea id="sweetheart-history" class="sweetheart-textarea" placeholder="TA的过往故事..."
                                  rows="3"></textarea>
                    </div>
                    <!-- 与用户的关系（可选） -->
                    <div class="sweetheart-field">
                        <label class="sweetheart-label">
                            <span class="label-icon">💗</span>
                            <span class="label-text">与我的关系</span>
                        </label>
                        <input type="text" id="sweetheart-relationship" class="sweetheart-input"
                               placeholder="朋友、同事、恋人...">
                    </div>
                    <!-- 绑定世界书（可折叠） -->
                    <div class="sweetheart-field">
                        <div class="sweetheart-label-toggle" onclick="toggleSweetheartWorldbooks()">
                            <div class="sweetheart-label">
                                <span class="label-icon">📚</span>
                                <span class="label-text">绑定的世界书</span>
                            </div>
                            <span class="toggle-arrow" id="sweetheart-wb-arrow">▼</span>
                        </div>
                        <div class="sweetheart-worldbooks-list" id="sweetheartWorldbooksList" style="display: none;">
                            <!-- JS动态生成 -->
                        </div>
                    </div>
                </div>
                <!-- 底部按钮 -->
                <div class="sweetheart-card-footer">
                    <button class="sweetheart-btn btn-cancel" onclick="closeSweetheartCardModal()">
                        <span>取消</span>
                    </button>
                    <button class="sweetheart-btn btn-save" onclick="saveSweetheartCardData()">
                        <span>💖 保存</span>
                    </button>
                </div>
                <!-- 隐藏的文件上传 -->
                <input type="file" id="sweetheart-avatar-input" accept="image/*" style="display: none;">
            </div>
        </div>

        <div class="chat-page" id="chatPage">
            <div class="chat-header">
                <div class="back-btn" onclick="closeChat()">←</div>
                <h2 class="chat-title" id="chatContactName"></h2> <!-- 将 div 改为 h2 更符合语义 -->

                <!-- 新增一个容器来包裹右侧的所有按钮 -->
                <div class="header-actions">
                    <div class="edit-contact-btn" onclick="editCurrentContact()">编辑</div>
                    <!-- 这就是我们新增的设置按钮 -->
                    <div class="chat-settings-btn" id="chatSettingsBtn" onclick="openChatSettings()">⚙️</div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
            </div>
            <div class="chat-input-area">
                <!-- 引用预览框现在是唯一的顶部元素 -->
                <div class="quote-preview" id="quotePreview">
                    <div class="quote-content">
                        <strong class="quote-sender" id="quotePreviewSender"></strong>
                        <span class="quote-text" id="quotePreviewText"></span>
                    </div>
                    <button class="quote-close-btn" onclick="cancelQuote()">&times;</button>
                </div>
                <!-- 新增一个包裹容器，用于水平排列输入框和按钮 -->
                <div class="chat-input-main-row">
                    <button class="chat-action-btn" id="showAttachmentMenuBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6Z"></path>
                        </svg>
                    </button>
                    <!-- 附件菜单和隐藏的input保持不变 -->
                    <div class="attachment-menu" id="attachmentMenu">
                        <div class="attachment-item" id="uploadFileBtn">
                            <div class="attachment-icon">📁</div>
                            <div class="attachment-label">文件</div>
                        </div>
                        <div class="attachment-item" id="uploadImageBtn">
                            <div class="attachment-icon">🖼️</div>
                            <div class="attachment-label">图片</div>
                        </div>
                    </div>
                    <input type="file" id="fileInput" style="display: none;">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <!-- 输入框 -->
                    <input type="text" id="chatInput" placeholder="输入消息...">

                    <!-- 发送键 -->
                    <button class="chat-action-btn primary" id="sendMsgBtn" onclick="addMessageToList()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M1.946 9.315c-.522-.174-.527-.455.01-.634l19.087-6.362c.529-.176.832.12.684.638l-5.454 19.086c-.15.529-.455.547-.679.045L12 14l6-8-8 6-8.054-2.685Z"></path>
                        </svg>
                    </button>
                    <!-- 回复键 -->
                    <button class="chat-action-btn" id="getReplyBtn" onclick="getAiReply()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0l-8 5-8-5h16zm0 12H4V8l8 5 8-5v10z"></path>
                        </svg>
                    </button>

                    <!-- 旧的添加按钮（已隐藏） -->
                    <button class="chat-action-btn" id="addMsgBtn" onclick="addMessageToList()" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6Z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="chat-settings-page" id="chatSettingsPage">
            <!-- 1. 顶部导航栏 -->
            <div class="settings-header">
                <div class="back-btn" onclick="closeChatSettings()">←</div>
                <div class="settings-title">聊天设置</div>
            </div>
            <!-- 2. 页面主要内容 -->
            <div class="settings-content">
                <div class="settings-section">
                    <div class="section-title">当前对话</div>
                    <!-- 3. 功能选项：清空记录 -->
                    <div class="settings-item" onclick="clearCurrentChatHistory()">
                        <div class="settings-icon"
                             style="background: linear-gradient(135deg, #ff758c, #ff7eb3);">
                            🗑️
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">清空聊天记录</div>
                            <div class="settings-desc">删除与当前联系人的所有消息</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-label">代码框滚动条</div>
                            <div class="settings-desc">开启后，过长的代码将出现水平滚动条</div>
                        </div>
                        <div class="settings-action">
                            <label class="toggle-switch">
                                <input type="checkbox" id="codeScrollToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="section-title">外观</div>
                        <div class="settings-section" style="padding: 0 20px; margin-bottom: 20px;">
                            <div class="form-group" style="padding: 10px;">
                                <label class="form-label" style="margin-bottom: 10px;">消息样式</label>
                                <div class="segmented-control" id="messageStyleSelector">
                                    <div class="segmented-option active" data-style="bubble">气泡</div>
                                    <div class="segmented-option" data-style="simple">简洁</div>
                                </div>
                            </div>
                        </div>
                        <!-- 更换聊天背景的设置项 -->
                        <div style="padding: 0 12px;">
                            <div class="app-preview-item">
                                <div class="preview-header">
                                    <div class="preview-icon">🖼️</div>
                                    <div class="preview-name">自定义聊天背景</div>
                                </div>
                                <div class="upload-section">
                                    <!-- 上传文件按钮 -->
                                    <label class="upload-btn">
                                        📁 上传文件
                                        <input type="file" class="file-input" accept="image/*"
                                               onchange="handleChatBgUpload(event)">
                                    </label>
                                    <!-- URL输入按钮 -->
                                    <div class="url-input-btn" onclick="toggleChatBgUrlInput()">🔗 URL填写</div>
                                </div>
                                <!-- URL输入框 (默认隐藏) -->
                                <div class="url-input-box" id="chat-bg-url-box">
                                    <input type="text" class="url-input-field" id="chat-bg-url-input"
                                           placeholder="输入图片URL">
                                    <button class="confirm-btn" onclick="applyChatBgFromUrl()">确认</button>
                                </div>
                                <!-- 状态消息提示 -->
                                <div class="status-message" id="chat-bg-status"></div>
                            </div>
                        </div>
                        <!-- 恢复默认背景的设置项 -->
                        <div class="settings-item" onclick="applyChatBackground('')">
                            <div class="settings-icon" style="background: #e9ecef;">
                                ✨
                            </div>
                            <div class="settings-info">
                                <div class="settings-label">恢复默认背景</div>
                                <div class="settings-desc">移除自定义聊天背景图</div>
                            </div>
                            <div class="settings-arrow">›</div>
                        </div>
                    </div>
                    <!-- 未来可以在这里添加更多设置项 -->
                </div>
            </div>
        </div>
        <div class="message-action-sheet" id="messageActionSheet">
            <div class="action-sheet-backdrop" onclick="hideMessageActionSheet()"></div>
            <div class="action-sheet-options">
                <!-- 新增的选项 -->
                <div class="action-option" id="copyMessageBtn">复制</div>
                <div class="action-option" id="regenerateMessageBtn">重新生成</div>
                <div class="action-option" id="quoteMessageBtn">引用</div>
                <!-- 保留并调整了原有的选项 -->
                <div class="action-option destructive" id="deleteMessageBtn">删除</div>
            </div>
            <!-- 为了美观，将取消按钮独立出来 -->
            <div class="action-sheet-options">
                <div class="action-option cancel" onclick="hideMessageActionSheet()">取消</div>
            </div>
        </div>
        <div id="floatingBall">🐾</div>
        <!-- 白色图标栏目 -->
        <div class="icon-dock-panel" id="iconDockPanel">
            <div class="dock-panel-header">
                <div class="dock-panel-title">我的收藏</div>
                <button class="dock-panel-close" onclick="closeIconDockPanel()">×</button>
            </div>
            <div class="dock-panel-content" id="dockPanelContent">
                <div class="dock-panel-empty">拖动图标到这里收藏</div>
            </div>
        </div>
        <!-- 悬浮球菜单 -->
        <div class="floating-ball-menu" id="floatingBallMenu">
            <div class="fb-menu-item" onclick="toggleIconDockPanel()">
                <span class="fb-menu-icon">⭐</span>
                <span class="fb-menu-label">图标收藏栏</span>
            </div>
            <div class="fb-menu-item" onclick="openSettings(); closeFloatingBallMenu()">
                <span class="fb-menu-icon">⚙️</span>
                <span class="fb-menu-label">设置</span>
            </div>
        </div>
        <div class="sweetheart-list-page" id="sweetheartListPage">
            <div class="sweetheart-list-header">
                <div class="back-btn" onclick="closeSweetheartList(true)">←</div>
                <div class="sweetheart-list-title">密友列表</div>
                <!-- V V V 新增的“添加”按钮 V V V -->
                <div class="add-contact-btn" onclick="addNewSweetheartContact()">+</div>
            </div>
            <div class="sweetheart-list-content" id="sweetheartListContainer">
                <!-- 联系人列表将由JS动态生成到这里 -->
            </div>
        </div>
        <!-- ========== 世界选择页面 ========== -->
        <div class="world-select-page" id="worldSelectPage">
            <div class="world-select-header">
                <div class="back-btn" onclick="closeWorldSelect()">←</div>
                <div class="world-select-title">请选择一个世界</div>
            </div>
            <div class="world-select-content" id="worldSelectContent">
                <!-- 世界列表将由JS动态生成 -->
            </div>
        </div>
        <!-- ========== 新建世界弹窗 ========== -->
        <div class="modal-overlay" id="newWorldModal">
            <div class="new-world-modal-card">
                <div class="new-world-header">
                    <span class="header-deco">🌍</span>
                    <span class="header-title">新建世界</span>
                    <span class="header-deco">🌍</span>
                </div>

                <div class="new-world-content">
                    <!-- 世界名称 -->
                    <div class="world-field required-field">
                        <label class="world-label">
                            <span class="label-icon">✨</span>
                            <span class="label-text">世界名称</span>
                            <span class="required-star">*</span>
                        </label>
                        <input type="text" id="worldNameInput" class="world-input" placeholder="给你的世界起个名字...">
                    </div>
                    <!-- 世界描述 -->
                    <div class="world-field">
                        <label class="world-label">
                            <span class="label-icon">📝</span>
                            <span class="label-text">世界描述</span>
                        </label>
                        <textarea id="worldDescInput" class="world-textarea" placeholder="描述一下这个世界的特点..."
                                  rows="3"></textarea>
                    </div>
                    <div class="world-field" id="worldMapField">
                        <label class="world-label">
                            <span class="label-icon">🗺️</span>
                            <span class="label-text">地图</span>
                        </label>
                        <!-- 地图预览区域 -->
                        <div class="world-map-preview-container" id="worldMapPreviewContainer"
                             onclick="toggleWorldMapOptions()">
                            <img id="worldMapPreview" src="" alt="World Map" style="display: none;">
                            <span id="worldMapPlaceholder">点击选择地图</span>
                        </div>
                        <!-- 地图选项 (默认隐藏) -->
                        <div class="world-map-options" id="worldMapOptions">
                            <button class="world-map-btn" onclick="selectDefaultMap()">默认地图</button>
                            <label class="world-map-btn">
                                导入图片
                                <input type="file" id="worldMapInput" accept="image/*" style="display: none;"
                                       onchange="handleWorldMapUpload(event)">
                            </label>
                        </div>
                    </div>
                    <!-- 绑定世界书 (可折叠) -->
                    <div class="world-field">
                        <div class="world-label-toggle" onclick="toggleWorldWorldbooks()">
                            <div class="world-label">
                                <span class="label-icon">📚</span>
                                <span class="label-text">绑定的世界书</span>
                            </div>
                            <span class="toggle-arrow" id="world-wb-arrow">▼</span>
                        </div>
                        <div class="world-worldbooks-list" id="worldWorldbooksList" style="display: none;">
                            <!-- JS动态生成 -->
                        </div>
                    </div>
                </div>

                <div class="new-world-footer">
                    <button class="world-btn btn-cancel" onclick="closeNewWorldModal()">取消</button>
                    <button class="world-btn btn-save" onclick="saveNewWorld()">创建</button>
                </div>
            </div>
        </div>
        <!-- ========== 世界书页面 - 开始 ========== -->
        <div class="worldbook-page" id="worldbookPage">
            <div class="worldbook-header">
                <div class="back-btn" onclick="closeWorldbook()">←</div>
                <div class="worldbook-title">世界书</div>
                <div style="display: flex; gap: 8px;">
                    <div class="category-manage-btn" onclick="openClassificationManage(event)" title="分类管理">🗂️</div>
                    <div class="category-manage-btn" onclick="openCategoryManage(event)" title="分组管理">📋</div>
                    <div class="add-contact-btn" onclick="openWorldbookModal()">+</div>
                </div>
            </div>

            <div class="worldbook-content" id="worldbookContent">
                <!-- 空状态（默认显示） -->
                <div class="worldbook-empty" id="worldbookEmpty">
                    <div class="worldbook-empty-icon">📖</div>
                    <div class="worldbook-empty-text">现在还没有世界书哦</div>
                    <div class="worldbook-empty-hint">点击右上角添加一个吧 ✨</div>
                </div>

                <!-- 条目列表（有数据时显示） -->
                <div class="worldbook-list" id="worldbookList" style="display: none;"></div>
            </div>
        </div>
        <!-- ========== 世界书弹窗 - 开始 ========== -->
        <div class="worldbook-modal" id="worldbookModal">
            <div class="worldbook-modal-card">
                <div class="worldbook-modal-header">
                    <div class="worldbook-modal-title" id="worldbookModalTitle">新建世界书</div>
                    <button class="worldbook-modal-close" onclick="closeWorldbookModal()">×</button>
                </div>

                <div class="worldbook-modal-body">
                    <!-- 1. 世界书名称 -->
                    <div class="worldbook-form-group">
                        <label class="worldbook-form-label">世界书名称</label>
                        <input type="text" class="worldbook-form-input" id="wbTitleInput"
                               placeholder="例如：魔法世界设定">
                    </div>

                    <!-- 2. 分类选择器 -->
                    <div class="worldbook-form-group">
                        <label class="worldbook-form-label">分类</label>
                        <div class="worldbook-category-selector" id="groupSelector">
                            <div class="category-selected" id="groupSelected">请选择分类</div>
                            <div class="category-options" id="groupOptions">
                                <div class="category-option" data-group="worldview">世界观</div>
                                <div class="category-option" data-group="rules">行为规范</div>
                                <div class="category-option" data-group="knowledge">知识库</div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 分类选择器（动态生成） -->
                    <div class="worldbook-form-group">
                        <label class="worldbook-form-label">分类</label>
                        <div class="worldbook-category-selector" id="categorySelector">
                            <div class="category-selected" id="categorySelected">请选择分类</div>
                            <div class="category-options" id="categoryOptions">
                                <!-- JS动态填充 -->
                            </div>
                        </div>
                    </div>

                    <!-- 4. 内容输入框 -->
                    <div class="worldbook-form-group">
                        <label class="worldbook-form-label" id="wbContentLabel">内容</label>
                        <textarea class="worldbook-form-textarea" id="wbContentInput"
                                  placeholder="请先选择分类..."></textarea>
                    </div>
                </div>


                <div class="worldbook-modal-footer">
                    <button class="worldbook-btn worldbook-btn-cancel" onclick="closeWorldbookModal()">取消</button>
                    <button class="worldbook-btn worldbook-btn-delete" id="worldbookDeleteBtn"
                            style="display: none;" onclick="deleteWorldbookEntry()">删除
                    </button>
                    <button class="worldbook-btn worldbook-btn-save" onclick="saveWorldbookEntry()">保存</button>
                </div>
            </div>
        </div>
        <!-- ========== 世界书弹窗 - 结束 ========== -->
        <!-- ========== 分类管理页面 - 开始 ========== -->
        <div class="category-manage-page" id="classificationManagePage">
            <div class="category-manage-header">
                <div class="back-btn" onclick="closeClassificationManage()">←</div>
                <div class="category-manage-title">分类管理</div>
            </div>
            <div class="category-manage-content" id="classificationManageContent">
                <!-- 空状态（默认显示）-->
                <div class="category-empty" id="classificationEmpty">
                    <div class="category-empty-icon">🗂️</div>
                    <div class="category-empty-text">所有分类都空空如也</div>
                    <div class="category-empty-hint">先去添加一些世界书条目吧 ✨</div>
                </div>
                <!-- 分类列表（有数据时显示）-->
                <div class="category-list" id="classificationList" style="display: none;"></div>
            </div>
        </div>
        <!-- ========== 分类管理页面 - 结束 ========== -->
        <!-- ========== 分组管理页面 - 开始 ========== -->
        <div class="category-manage-page" id="categoryManagePage">
            <div class="category-manage-header">
                <div class="back-btn" onclick="closeCategoryManage()">←</div>
                <div class="category-manage-title">分组管理</div>
                <div class="add-category-btn" onclick="openNewCategoryModal()">+</div>
            </div>
            <div class="category-manage-content" id="categoryManageContent">
                <!-- 空状态（默认显示）-->
                <div class="category-empty" id="categoryEmpty">
                    <div class="category-empty-icon">📂</div>
                    <div class="category-empty-text">现在还没有分组哦</div>
                    <div class="category-empty-hint">点击右上角添加一个吧 ✨</div>
                </div>
                <!-- 分组列表（有数据时显示）-->
                <div class="category-list" id="categoryList" style="display: none;"></div>
            </div>
        </div>
        <!-- ========== 新建分组弹窗 ========== -->
        <div class="category-modal" id="categoryModal">
            <div class="category-modal-card">
                <div class="category-modal-header">
                    <div class="category-modal-title" id="categoryModalTitle">新建分组</div>
                    <button class="category-modal-close" onclick="closeCategoryModal()">×</button>
                </div>
                <div class="category-modal-body">
                    <div class="category-form-group">
                        <label class="category-form-label">分组名称</label>
                        <input type="text" class="category-form-input" id="categoryNameInput"
                               placeholder="例如：魔法系统">
                    </div>
                    <div class="category-form-group">
                        <label class="category-form-label">分组描述</label>
                        <textarea class="category-form-textarea" id="categoryDescInput"
                                  placeholder="简单描述这个分组的用途..."></textarea>
                    </div>
                </div>
                <div class="category-modal-footer">
                    <button class="category-btn category-btn-cancel" onclick="closeCategoryModal()">取消</button>
                    <button class="category-btn category-btn-delete" id="categoryDeleteBtn"
                            style="display: none;" onclick="deleteCategory()">删除
                    </button>
                    <button class="category-btn category-btn-save" onclick="saveCategory()">保存</button>
                </div>
            </div>
        </div>
        <!-- ========== 分组管理 - 结束 ========== -->


    </div>

</div>

<!-- 2. 引入外部的JavaScript文件 (defer属性确保HTML解析完再执行) -->
<script src="script.js" defer></script>
</body>
</html>
