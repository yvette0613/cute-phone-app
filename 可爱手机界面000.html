<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可爱手机界面</title>
    <style>
        .settings-page,
        .config-page,
        .beautify-page,
        .contacts-page {
            position: absolute;
            left: 0;
            width: 100%;
            top: 0;
            bottom: 0;
            height: auto;
        }

        /* ========== 开始：粘贴这段全新的、修正后的代码块CSS ========== */

        /* 1. 让包裹容器继承宽度限制 */
        .code-block-wrapper {
            max-width: 100%;
        }

        /* 2. <pre> 标签的默认样式（换行，无滚动条） */
        .code-block-wrapper pre {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 36px 12px 12px 12px; /* 顶部留出空间给按钮 */
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            margin: 0; /* margin 移到 wrapper 上了 */

            /* 默认换行规则 */
            white-space: pre-wrap;
            word-break: break-all; /* 使用 break-all 更强制地断行 */
            box-sizing: border-box;
        }

        /* 3. 开启滚动条模式时，修改包裹容器和<pre>的行为 */

        /* --- 用下面这个新版本替换它 --- */
        body.code-scrolling-enabled .code-block-wrapper pre {
            white-space: pre;
            word-break: normal;
            overflow-x: auto; /* <<< --- 核心修改：滚动条在这里！--- <<< */
            flex: 1; /* <<< --- 新增：让pre元素占据所有可用空间 --- <<< */
            min-width: 0; /* <<< --- 新增：允许pre元素收缩 --- <<< */
        }


        .chat-bubble code {
            padding: 0;
            background: transparent;
            border-radius: 0;
            font-family: inherit;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
        }

        /* --- 复制并粘贴这一整块全新的聊天界面样式 --- */

        /* ===== 高级简约聊天界面样式 - 开始 ===== */

        .chat-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f7f8fa; /* 柔和的背景色 */
            z-index: 1005;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .chat-page.show {
            transform: translateY(0);
        }

        /* ========== 开始：【最终修正版】简洁聊天样式 ========== */

        /* 当 chat-page 拥有 simple-style 类时触发 */
        .chat-page.simple-style .message-row {
            flex-direction: row; /* 强制所有消息行都从左到右排列 */
            align-items: flex-start; /* 头像和内容顶部对齐 */
            gap: 12px;
        }

        /* 消息内容容器，用于包裹发送者和消息文本 */
        /* 这是解决问题的关键！ */
        .chat-page.simple-style .message-content {
            display: flex;
            flex-direction: column;
            gap: 4px; /* 发送者和消息之间的间距 */
            min-width: 0; /* 关键修复！允许flex子项收缩，防止被内部内容撑开 */
        }

        /* 移除气泡的所有样式 */
        .chat-page.simple-style .chat-bubble {
            background: transparent;
            color: #333; /* 文本颜色恢复为深色 */
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-left: 0 !important; /* 覆盖掉 sent 消息的 margin-left: auto */
        }

        /* 简洁模式下，发送消息的气泡也不再有特殊颜色 */
        .chat-page.simple-style .message-row.sent .chat-bubble {
            background: transparent;
            color: #333;
        }

        /* 发送者名称的样式 */
        .message-sender-name {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        /* 默认隐藏头像和名字，只在简洁模式下显示 */
        .message-chat-avatar,
        .message-sender-name {
            display: none;
        }

        .chat-page.simple-style .message-chat-avatar,
        .chat-page.simple-style .message-sender-name {
            display: block; /* 在简洁模式下显示它们 */
        }

        /* 聊天中的小头像样式 */
        .message-chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            flex-shrink: 0;
            overflow: hidden;
            background: #ccc;
        }

        .message-chat-avatar img,
        .message-chat-avatar .initials {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
        }

        /* ========== 结束：【最终修正版】简洁聊天样式 ========== */


        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 45px 12px 12px; /* 调整内边距 */
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); /* 更柔和的阴影 */
            flex-shrink: 0;
            position: relative;
            z-index: 2;
        }

        .chat-header .back-btn {
            margin-right: 8px;
        }

        .chat-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 17px; /* 稍微调整字体大小 */
            font-weight: 600;
            color: #000;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 55%;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0; /* 按钮之间不留空隙 */
        }

        .edit-contact-btn, .chat-settings-btn {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            color: #0A84FF; /* 统一为品牌蓝色 */
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .chat-settings-btn {
            font-size: 20px; /* 让图标稍大一些 */
        }

        .edit-contact-btn:hover, .chat-settings-btn:hover {
            background-color: #f0f2f5;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-color: rgba(247, 248, 250, 0.85); /* 新增此行 */
        }


        .chat-messages::-webkit-scrollbar {
            display: none;
        }

        .message-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 100%;
        }

        /* ===== 最终修复方案 - 开始 ===== */
        .message-row.sent {
            /* justify-content: flex-end; */ /* 我们不再需要这个了 */
            flex-direction: row-reverse;
        }

        .message-row.sent .chat-bubble {
            /* 关键：让气泡的左外边距自动撑开，将自己推到最右边 */
            margin-left: auto;
        }

        /* ===== 最终修复方案 - 结束 ===== */

        .message-row.received {
            justify-content: flex-start;
        }

        .chat-bubble {
            max-width: 100%; /* 交由 message-row 控制最大宽度 */
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 16px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .message-row.received .chat-bubble {
            background: #e9e9eb;
            color: #000;
            border-bottom-left-radius: 5px;
            margin-right: auto;
        }

        .message-row.sent .chat-bubble {
            background: #0A84FF;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .delete-msg-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .message-row:hover .delete-msg-btn {
            opacity: 1;
        }

        .delete-msg-btn:hover {
            background: #fecaca;
            color: #b91c1c;
        }

        .chat-input-area {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #fff;
            border-top: 1px solid #e5e5e5;
            flex-shrink: 0;
            gap: 8px;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: #f0f2f5;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
        }

        .chat-input-area .chat-action-btn {
            width: 38px;
            height: 38px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background: #f0f2f5;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .chat-input-area .chat-action-btn svg {
            width: 20px;
            height: 20px;
            fill: #6c757d;
        }

        .chat-input-area .chat-action-btn.primary {
            background: #0A84FF;
        }

        .chat-input-area .chat-action-btn.primary svg {
            fill: white;
        }

        .chat-settings-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1006;
            display: flex;
            flex-direction: column;
        }

        .chat-settings-page.show {
            transform: translateX(0);
        }

        /* ===== 高级简约聊天界面样式 - 结束 ===== */

        /* ------------------------------------------- */


        .phone {
            width: 375px;
            height: 812px;
            background: #000;
            border-radius: 40px;
            padding: 12px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
            position: relative;
            margin: auto;
        }

        .phone::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 28px;
            background: #000;
            border-radius: 0 0 20px 20px;
            z-index: 999;
        }

        /* ========== 开始：粘贴这段全新的 CSS 代码 ========== */

        /* 当 body 标签拥有 fullscreen-enabled 类时，激活以下样式 */
        body.fullscreen-enabled .phone {
            width: 100vw; /* 视口宽度，占满整个浏览器窗口宽度 */
            height: 100vh; /* 视口高度，占满整个浏览器窗口高度 */
            border-radius: 0; /* 移除圆角 */
            padding: 0; /* 移除内边距 */
            background: transparent; /* 边框背景变透明 */
            box-shadow: none; /* 移除阴影 */
            margin: 0; /* 移除外边距，确保完全贴合 */
        }

        body.fullscreen-enabled .screen {
            border-radius: 0; /* 屏幕也移除圆角，以匹配父容器 */
        }

        /* 移除刘海屏的黑色遮挡 */
        body.fullscreen-enabled .phone::before {
            display: none;
        }

        /* 同时让 body 在全屏时没有内边距 */
        body.fullscreen-enabled {
            padding: 0;
        }

        /* ========== 结束：粘贴 CSS 代码 ========== */


        .screen {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #fef5f9 0%, #f0e6f5 100%);
            border-radius: 30px;
            overflow: hidden;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }

        .pages-wrapper {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .pages-wrapper.no-transition {
            transition: none;
        }

        .page {
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 40px 20px 12px;
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }

        .status-icons {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .status-icon-svg {
            width: 25px;
            height: 25px;
            fill: currentColor;
            display: block;
        }

        .battery-container {
            display: flex;
            align-items: center;
            gap: 1px;
            position: relative;
            top: -5px;
        }

        .battery-icon {
            position: relative;
            width: 34px;
            height: 17px;
        }

        .battery-icon svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .battery-level {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 2px;
            right: 6px;
            height: 8px;
            background-color: #1a1a1a;
            border-radius: 2px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .battery-level.low {
            background-color: #ff4757;
        }

        .charging-bolt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 9px;
            height: 9px;
            fill: #1a1a1a;
            display: none;
        }

        .battery-container.charging .charging-bolt {
            display: block;
        }

        .battery-container.charging .battery-level {
            display: none;
        }

        .battery-text {
            font-size: 12px;
            font-weight: 600;
            line-height: 12px;
        }

        .time-weather-section {
            flex-shrink: 0;
            padding: 0 20px 12px;
            position: relative;
            z-index: 50;
        }

        .time-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            border-radius: 22px;
            padding: 16px 24px;
            text-align: center;
            margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(168, 201, 245, 0.15);
            border: 1px solid rgba(168, 201, 245, 0.2);
            backdrop-filter: blur(10px);
        }

        .time-card h2 {
            font-size: 52px;
            color: #8ba9d9;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: -1px;
        }

        .time-card .day {
            color: #a8c9f5;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .weather-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            border-radius: 22px;
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(168, 201, 245, 0.15);
            border: 1px solid rgba(168, 201, 245, 0.2);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(168, 201, 245, 0.15);
        }

        .location-display {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .location-icon {
            font-size: 16px;
        }

        .location-text {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .weather-display {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 12px;
            background: rgba(168, 201, 245, 0.1);
            transition: all 0.2s;
        }

        .weather-display:hover {
            background: rgba(168, 201, 245, 0.2);
            transform: scale(1.05);
        }

        .current-weather-icon {
            font-size: 28px;
            display: block;
        }

        .mood-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            cursor: pointer;
            padding: 12px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 240, 245, 0.5), rgba(255, 230, 240, 0.3));
            transition: all 0.2s;
        }

        .mood-section:hover {
            background: linear-gradient(135deg, rgba(255, 240, 245, 0.7), rgba(255, 230, 240, 0.5));
            transform: scale(1.02);
        }

        .mood-label {
            font-size: 11px;
            color: #888;
            font-weight: 600;
        }

        .mood-text {
            font-size: 15px;
            color: #333;
            font-weight: 500;
            min-height: 20px;
        }

        .mood-text.empty {
            color: #aaa;
            font-style: italic;
        }

        .weather-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 100;
            min-width: 200px;
        }

        .weather-popup-title {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }

        .weather-options {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .weather-option {
            font-size: 36px;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s;
            opacity: 0.4;
        }

        .weather-option:hover {
            transform: scale(1.15);
            opacity: 0.7;
        }

        .weather-option.active {
            opacity: 1;
            background: rgba(168, 201, 245, 0.15);
            transform: scale(1.1);
        }


        .grid-container {
            flex: 1;
            padding: 12px 20px 120px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 14px;
            position: relative;
            overflow-y: visible;
            align-content: start;
        }


        .grid-container::-webkit-scrollbar {
            display: none;
        }

        .app-icon {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.15s ease;
            z-index: 10;
            user-select: none;
            padding: 4px;
        }

        .app-icon:active:not(.dragging) {
            transform: scale(0.95);
        }

        .app-icon.dragging {
            z-index: 150;
            opacity: 0.85;
            transform: scale(1.08) rotate(1deg);
            transition: none;
        }

        .icon-wrapper {
            width: 62px;
            height: 62px;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.92));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08),
            0 1px 4px rgba(168, 201, 245, 0.15);
            pointer-events: none;
            overflow: hidden;
        }

        .icon-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .badge {
            position: absolute;
            top: -2px;
            right: 4px;
            background: #ff4757;
            color: white;
            border-radius: 10px;
            padding: 2px 5px;
            min-width: 18px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            z-index: 15;
            box-shadow: 0 2px 4px rgba(255, 71, 87, 0.3);
            pointer-events: none;
        }

        .app-label {
            font-size: 12px;
            color: #FFF;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
            text-align: center;
            max-width: 70px;
            overflow: visible;
            white-space: nowrap;
            font-weight: 500;
            pointer-events: none;
            line-height: 1.2;
        }

        .folder .icon-wrapper {
            background: linear-gradient(135deg, rgba(255, 220, 240, 0.9), rgba(255, 200, 220, 0.8));
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            padding: 8px;
        }

        .folder-mini-icon {
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .widget {
            position: absolute;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 40%, #b8a7e8 100%);
            border-radius: 22px;
            padding: 16px;
            color: white;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            z-index: 5;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .widget.dragging {
            z-index: 150;
            opacity: 0.85;
            transform: scale(1.03);
        }

        .widget-scene {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #ffb3c9 0%, #a899e3 50%, #6b89ff 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            margin-top: 6px;
            pointer-events: none;
        }

        .building {
            position: absolute;
            bottom: 0;
            background: rgba(139, 92, 131, 0.75);
            border-radius: 4px 4px 0 0;
        }

        .widget-time {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: 0.3px;
            pointer-events: none;
        }

        .page-dots {
            position: absolute;
            bottom: 95px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 7px;
            z-index: 200;
        }

        .dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(2px);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .dot.active {
            background: rgba(255, 255, 255, 0.9);
            width: 18px;
            border-radius: 3.5px;
        }

        .dock {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
            background: rgba(255, 255, 255, 0.5);
            padding: 8px 20px;
            border-radius: 24px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            z-index: 200;
            backdrop-filter: blur(10px);
        }

        .dock-icon {
            width: 56px;
            height: 56px;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.92));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .dock-icon:active {
            transform: scale(0.92);
        }

        .edit-hint {
            position: absolute;
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 22px;
            font-size: 12px;
            width: 200px;
            text-align: center;
            font-weight: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 300;
            backdrop-filter: blur(10px);
        }

        .edit-hint.show {
            opacity: 1;
        }

        #editHint2 {
            display: none;
        }

        .settings-page, .config-page, .beautify-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .settings-page.show, .config-page.show, .beautify-page.show {
            transform: translateX(0);
        }

        .config-page {
            z-index: 1001;
        }

        .settings-header {
            display: flex;
            align-items: center;
            padding: 45px 20px 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(168, 201, 245, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            color: #333;
            font-weight: bold;
        }

        .back-btn:active {
            transform: scale(0.9);
            background: rgba(168, 201, 245, 0.25);
        }

        .settings-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-right: 36px;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }

        .settings-content::-webkit-scrollbar {
            display: none;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .section-title {
            padding: 12px 20px 8px;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .settings-item {
            background: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .settings-item:first-of-type {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .settings-item:last-of-type {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            border-bottom: none;
        }

        .settings-item:active {
            background: #f8f9fa;
        }

        .settings-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 14px;
        }

        .settings-info {
            flex: 1;
        }

        .settings-label {
            font-size: 15px;
            color: #333;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .settings-desc {
            font-size: 12px;
            color: #888;
        }

        .settings-arrow {
            font-size: 16px;
            color: #bbb;
            font-weight: bold;
        }

        .form-group {
            background: white;
            padding: 20px;
            margin-bottom: 2px;
        }

        .form-group:first-of-type {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .form-group:last-of-type {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #a8c9f5;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin: 20px;
        }

        .save-btn, .test-btn, .fetch-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .save-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .test-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        .fetch-btn {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: white;
        }

        .save-btn:active, .test-btn:active, .fetch-btn:active {
            transform: scale(0.98);
        }

        .api-config-list {
            margin: 0 20px 20px;
        }

        .api-config-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-details {
            flex: 1;
            min-width: 0;
        }

        .delete-config-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f1f2f6;
            border: none;
            color: #a4b0be;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 12px;
            transition: all 0.2s ease;
        }

        .delete-config-btn:hover {
            background: #ff4757;
            color: white;
            transform: scale(1.1) rotate(90deg);
        }

        .api-config-item:active {
            transform: scale(0.98);
        }

        .api-config-item.active {
            border: 2px solid #667eea;
            background: #f0f4ff;
        }

        .config-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .config-url {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .add-new-btn {
            width: 100%;
            padding: 14px;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-new-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .app-preview-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .app-preview-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .preview-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .preview-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.92));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .preview-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .upload-section {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .upload-btn, .url-input-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
            font-weight: 600;
            color: #666;
        }

        .upload-btn:hover, .url-input-btn:hover {
            border-color: #a8c9f5;
            color: #667eea;
        }

        .file-input {
            display: none;
        }

        .url-input-box {
            margin-top: 8px;
            display: none;
        }

        .url-input-box.show {
            display: block;
        }

        .url-input-field {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .url-input-field:focus {
            outline: none;
            border-color: #a8c9f5;
        }

        .confirm-btn {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .status-message {
            margin-top: 8px;
            font-size: 11px;
            color: #28a745;
            font-weight: 600;
        }

        .status-message.error {
            color: #dc3545;
        }

        .delete-time-btn, .delete-weather-btn, .delete-widget-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 71, 87, 0.9);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 250;
        }

        .time-card {
            position: relative;
        }

        .weather-card {
            position: relative;
        }

        .time-card.show-delete .delete-time-btn {
            display: flex;
        }

        .weather-card.show-delete .delete-weather-btn {
            display: flex;
        }

        .widget.show-delete .delete-widget-btn {
            display: flex;
        }

        .saved-widget-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .saved-widget-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .restore-btn {
            flex: 1;
            padding: 8px;
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .delete-saved-btn {
            flex: 1;
            padding: 8px;
            background: #f5f5f5;
            color: #666;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .contacts-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1002;
            display: flex;
            flex-direction: column;
        }

        .contacts-page.show {
            transform: translateY(0);
        }

        .contacts-header {
            display: flex;
            align-items: center;
            padding: 45px 20px 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .contacts-search {
            flex: 1;
            padding: 10px 16px;
            background: rgba(168, 201, 245, 0.1);
            border: none;
            border-radius: 20px;
            font-size: 14px;
            margin: 0 12px;
        }

        .contacts-search:focus {
            outline: none;
            background: rgba(168, 201, 245, 0.2);
        }

        .add-contact-btn {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(168, 201, 245, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            color: #333;
            font-weight: bold;
        }

        .add-contact-btn:active {
            transform: scale(0.9);
            background: rgba(168, 201, 245, 0.25);
        }

        .contact-menu {
            position: absolute;
            top: 100%;
            right: 20px;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: none;
            z-index: 1003;
            min-width: 160px;
        }

        .contact-menu.show {
            display: block;
        }

        .contact-menu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .contact-menu-item:last-child {
            border-bottom: none;
        }

        .contact-menu-item:active {
            background: #f8f9fa;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }

        .contacts-list::-webkit-scrollbar {
            display: none;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .contact-item:active {
            background: #f8f9fa;
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .contact-status {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .contact-badge {
            background: #ff4757;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            min-width: 18px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            padding: 0 20px;
        }

        .wallpaper-thumbnail {
            width: 100%;
            padding-top: 150%;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 3px solid transparent;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            position: relative;
        }

        .wallpaper-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .wallpaper-thumbnail.active {
            border-color: #667eea;
            transform: scale(1.02);
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1010;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .character-card-modal {
            background: #fff;
            border: 6px solid #000;
            border-radius: 24px;
            width: 100%;
            max-width: 330px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .modal-overlay.show .character-card-modal {
            transform: scale(1);
        }

        .character-card-content {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .top-info-section {
            display: flex;
            gap: 18px;
        }

        .character-avatar {
            flex-shrink: 0;
            width: 90px;
            height: 90px;
            border: 2px solid #eee;
            border-radius: 12px;
            background: #f8f8f8;
            cursor: pointer;
            overflow: hidden;
        }

        .character-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .core-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .core-details input[type="text"] {
            width: 100%;
            border: none;
            border-bottom: 2px solid #ccc;
            padding: 6px 0;
            font-size: 20px;
            font-weight: bold;
            background: transparent;
            color: #000;
            transition: border-color 0.2s;
        }

        .core-details input[type="text"]:focus {
            outline: none;
            border-bottom-color: #000;
        }

        .character-gender-selection {
            color: #555;
            font-size: 14px;
        }

        .character-gender-selection input {
            margin-right: 4px;
        }

        .character-id {
            font-size: 12px;
            color: #888;
            margin-top: auto;
            font-family: 'Menlo', 'Monaco', monospace;
        }

        .persona-section {
            width: 100%;
        }

        .persona-section textarea {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 12px;
            background: #f8f8f8;
            font-size: 14px;
            color: #333;
            resize: vertical;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .persona-section textarea:focus {
            outline: none;
            border-color: #aaa;
            background: #fff;
        }

        .character-card-footer {
            display: flex;
            background: #f8f8f8;
            border-top: 2px solid #eee;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            overflow: hidden;
        }

        .character-card-btn {
            flex: 1;
            padding: 14px;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            color: #888;
        }

        .character-card-btn:hover {
            background: #eee;
        }

        .character-card-btn.save {
            background: #000;
            color: #fff;
        }

        .character-card-btn.save:hover {
            background: #333;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }


        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-action-sheet {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1004;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .avatar-action-sheet.show {
            opacity: 1;
            visibility: visible;
        }

        .action-sheet-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
        }

        .action-sheet-options {
            position: relative;
            z-index: 1;
            background: #f0f2f5;
            padding: 8px;
            margin: 8px;
            border-radius: 14px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .avatar-action-sheet.show .action-sheet-options {
            transform: translateY(0);
        }

        .action-option {
            background: #fff;
            padding: 16px;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            color: #007aff;
            cursor: pointer;
            border-bottom: 1px solid #e5e5e5;
        }

        .action-option:first-child {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .action-option:last-child {
            border-bottom: none;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .action-option.cancel {
            background: #fff;
            margin-top: 8px;
            border-radius: 12px;
            font-weight: 600;
        }


        .success-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2500;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .success-modal.show {
            opacity: 1;
        }

        .modal-content {
            background: white;
            padding: 24px 32px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .success-modal.show .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            margin: 0 0 8px;
            font-size: 18px;
            color: #333;
        }

        .modal-content p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        /* --- 复制并粘贴这段代码 --- */
        .settings-item {
            justify-content: space-between;
        }

        .settings-action {
            flex-shrink: 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* ========== 开始：粘贴这段新的 CSS 代码 ========== */
        .message-action-sheet {
            /* 样式与 avatar-action-sheet 类似，但有独立类名以防冲突 */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1008; /* 层级高于聊天页面 */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-action-sheet.show {
            opacity: 1;
            visibility: visible;
        }

        .message-action-sheet .action-sheet-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
        }

        .message-action-sheet .action-sheet-options {
            position: relative;
            z-index: 1;
            background: #f0f2f5;
            padding: 8px;
            margin: 8px;
            border-radius: 14px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .message-action-sheet.show .action-sheet-options {
            transform: translateY(0);
        }

        /* 为删除选项添加特殊的危险颜色 */
        .action-option.destructive {
            color: #ff3b30; /* iOS 风格的红色 */
        }

        /* 移除旧的、不再需要的删除按钮样式 */
        .delete-msg-btn {
            display: none; /* 直接隐藏，不再使用 */
        }

        /* ========== 开始：为代码块复制功能添加新样式 ========== */

        /* 1. 代码块的包裹容器 */
        /* 我们用一个 div 把 <pre> 和 <button> 包起来，方便定位 */
        /* --- 用这个新版本替换旧的 .code-block-wrapper --- */
        .code-block-wrapper {
            position: relative; /* 保持相对定位，作为按钮的定位锚点 */
            display: flex; /* <<< --- 新增：使用Flexbox布局 --- <<< */
            max-width: 100%;
            margin: 8px 0;
        }


        /* 2. 微调一下 pre 标签的样式 */
        /* 将 margin 移除，因为它已经在父容器上了 */
        .code-block-wrapper pre {
            margin: 0;
            /* 增加上方的内边距，给按钮留出空间 */
            padding-top: 36px;
        }


        /* 3. 复制按钮的样式 */
        .copy-code-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #a0a0a0;
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            cursor: pointer;
            opacity: 0; /* 默认隐藏 */
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 4px; /* 图标和文字的间距 */
        }

        /* 4. 当鼠标悬停在整个代码块上时，显示按钮 */
        .code-block-wrapper:hover .copy-code-btn {
            opacity: 1;
        }

        /* 5. 按钮悬停时的效果 */
        .copy-code-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #d4d4d4;
        }

        /* 6. 按钮点击后的“已复制”状态 */
        .copy-code-btn.copied {
            background-color: #28a745; /* 绿色背景表示成功 */
            color: white;
        }

        /* 7. SVG 图标样式 */
        .copy-code-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }


        /* ========== 开始：分段选择器UI样式 ========== */
        .segmented-control {
            display: flex;
            background-color: #e9e9eb;
            border-radius: 8px;
            padding: 2px;
        }

        .segmented-option {
            flex: 1;
            padding: 6px 0;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
        }

        .segmented-option.active {
            background-color: white;
            color: #000;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* ========== 开始：粘贴这段全新的 CSS 代码块 ========== */

        /* 1. 调整输入区域，为新按钮腾出空间 */
        .chat-input-area {
            position: relative; /* 这是让菜单定位的关键！ */
        }

        /* 2. 附件菜单容器的样式 */
        .attachment-menu {
            position: absolute; /* 相对于 .chat-input-area 定位 */
            bottom: 60px; /* 定位在输入框上方 */
            left: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 16px;
            padding: 12px;

            /* 默认隐藏的动画属性 */
            opacity: 0;
            transform: translateY(10px);
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10;
        }

        /* 3. 当菜单拥有 .show 类时，将它显示出来 */
        .attachment-menu.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        /* 4. 菜单中每个选项的样式 */
        .attachment-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        /* 5. 选项中的图标样式 */
        .attachment-icon {
            width: 56px;
            height: 56px;
            background-color: #f0f2f5;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: transform 0.2s;
        }

        .attachment-item:hover .attachment-icon {
            transform: scale(1.05);
        }

        /* 6. 选项中的文字标签样式 */
        .attachment-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }

        /* 7. 调整旧的 #addMsgBtn，现在它变成了“+”按钮，所以样式也需要改一下 */
        #addMsgBtn {
            display: none; /* 隐藏旧的添加按钮，现在被发送按钮替代 */
        }

        /* ========== 结束：粘贴 CSS 代码块 ========== */


    </style>
</head>
<body>
<div class="phone">
    <div class="success-modal" id="successModal">
        <div class="modal-content">
            <h3 id="successModalTitle">操作成功</h3>
            <p id="successModalMessage">你的设置已保存。</p>
        </div>
    </div>
    <div class="screen" id="screen">
        <div class="pages-wrapper" id="pagesWrapper">
            <div class="page" id="page1">
                <div class="status-bar">
                    <span>19:05</span>
                    <div class="status-icons">
                        <svg class="status-icon-svg" viewBox="0 0 24 24">
                            <path fill-rule="evenodd"
                                  d="M12 4.5C7.31 4.5 3.19 6.84 1.33 10.33l1.83.92C4.69 8.23 8.01 6.5 12 6.5s7.31 1.73 8.84 4.75l1.83-.92C20.81 6.84 16.69 4.5 12 4.5zM12 9.5c-3.31 0-6.13 1.5-7.58 3.82l1.83.91C7.43 12.19 9.53 11.5 12 11.5s4.57.69 5.75 2.73l1.83-.91C18.13 11 15.31 9.5 12 9.5zM12 14.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5z"></path>
                        </svg>
                        <div class="battery-container">
                            <div class="battery-icon">
                                <svg viewBox="0 0 26 14" fill="none">
                                    <path d="M24 4.33333V9.66667C25.1046 9.66667 26 8.77123 26 7.66667C26 6.5621 25.1046 5.66667 24 5.66667V4.33333Z"
                                          fill="currentColor"></path>
                                    <path d="M1 4.66667C1 3.19391 2.19391 2 3.66667 2H20.3333C21.8061 2 23 3.19391 23 4.66667V9.33333C23 10.8061 21.8061 12 20.3333 12H3.66667C2.19391 12 1 10.8061 1 9.33333V4.66667Z"
                                          stroke="currentColor" stroke-width="2"></path>
                                </svg>
                                <div class="battery-level"></div>
                                <svg class="charging-bolt" viewBox="0 0 24 24">
                                    <path d="M11 21v-8H7l5-10v8h4l-5 10z"></path>
                                </svg>
                            </div>
                            <span class="battery-text">100%</span>
                        </div>
                    </div>
                </div>

                <div class="time-weather-section">
                    <div class="time-card" id="timeCard">
                        <div class="delete-time-btn" onclick="deleteTimeCard()">×</div>
                        <h2>19:05</h2>
                        <div class="day">WEDNESDAY</div>
                    </div>

                    <div class="weather-card" id="weatherCard">
                        <div class="delete-weather-btn" onclick="deleteWeatherCard()">×</div>

                        <div class="top-row">
                            <div class="location-display">
                                <span class="location-icon">📍</span>
                                <span class="location-text">越秀区</span>
                            </div>
                            <div class="weather-display" onclick="toggleWeatherSelector(event)">
                                <span class="current-weather-icon" id="currentWeatherIcon">☀️</span>
                            </div>
                        </div>

                        <div class="mood-section" onclick="editMood(event)">
                            <div class="mood-label">今日心情</div>
                            <div class="mood-text" id="moodText">点击填写心情...</div>
                        </div>

                        <div class="weather-popup" id="weatherPopup" style="display: none;">
                            <div class="weather-popup-title">选择天气</div>
                            <div class="weather-options">
                                    <span class="weather-option active" data-weather="sunny"
                                          onclick="selectWeather('sunny', event)">☀️</span>
                                <span class="weather-option" data-weather="cloudy"
                                      onclick="selectWeather('cloudy', event)">☁️</span>
                                <span class="weather-option" data-weather="rainy"
                                      onclick="selectWeather('rainy', event)">🌧️</span>
                                <span class="weather-option" data-weather="snowy"
                                      onclick="selectWeather('snowy', event)">❄️</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid-container" id="grid1"></div>
            </div>

            <div class="page" id="page2">
                <div class="status-bar">
                    <span>19:05</span>
                    <div class="status-icons">
                        <svg class="status-icon-svg" viewBox="0 0 24 24">
                            <path fill-rule="evenodd"
                                  d="M12 4.5C7.31 4.5 3.19 6.84 1.33 10.33l1.83.92C4.69 8.23 8.01 6.5 12 6.5s7.31 1.73 8.84 4.75l1.83-.92C20.81 6.84 16.69 4.5 12 4.5zM12 9.5c-3.31 0-6.13 1.5-7.58 3.82l1.83.91C7.43 12.19 9.53 11.5 12 11.5s4.57.69 5.75 2.73l1.83-.91C18.13 11 15.31 9.5 12 9.5zM12 14.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5z"></path>
                        </svg>
                        <div class="battery-container">
                            <div class="battery-icon">
                                <svg viewBox="0 0 26 14" fill="none">
                                    <path d="M24 4.33333V9.66667C25.1046 9.66667 26 8.77123 26 7.66667C26 6.5621 25.1046 5.66667 24 5.66667V4.33333Z"
                                          fill="currentColor"></path>
                                    <path d="M1 4.66667C1 3.19391 2.19391 2 3.66667 2H20.3333C21.8061 2 23 3.19391 23 4.66667V9.33333C23 10.8061 21.8061 12 20.3333 12H3.66667C2.19391 12 1 10.8061 1 9.33333V4.66667Z"
                                          stroke="currentColor" stroke-width="2"></path>
                                </svg>
                                <div class="battery-level"></div>
                                <svg class="charging-bolt" viewBox="0 0 24 24">
                                    <path d="M11 21v-8H7l5-10v8h4l-5 10z"></path>
                                </svg>
                            </div>
                            <span class="battery-text">100%</span>
                        </div>
                    </div>
                </div>

                <div class="grid-container" id="grid2"></div>
            </div>
        </div>

        <div class="edit-hint" id="editHint1">长按图标可以拖动调整位置</div>
        <div class="edit-hint" id="editHint2">长按图标可以拖动调整位置</div>

        <div class="page-dots">
            <div class="dot active" onclick="showPage(1)"></div>
            <div class="dot" onclick="showPage(2)"></div>
        </div>

        <div class="dock">
            <div class="dock-icon" data-index="0" onclick="openContacts()">💬</div>
            <div class="dock-icon" data-index="1">🎵</div>
            <div class="dock-icon" data-index="2">💬</div>
            <div class="dock-icon" data-index="3">🱱</div>
        </div>

        <div class="settings-page" id="settingsPage">
            <div class="settings-header">
                <div class="back-btn" onclick="closeSettings()">←</div>
                <div class="settings-title">设置</div>
            </div>

            <div class="settings-content">
                <div class="settings-section">
                    <div class="section-title">配置</div>
                    <div class="settings-item" onclick="openApiConfig()">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">🔌
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">API设置</div>
                            <div class="settings-desc">管理API配置和模型</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item" onclick="openConfig('database')">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">🗄️
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">数据库设置</div>
                            <div class="settings-desc">配置Supabase数据库</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #89f7fe, #66a6ff);">📱
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">全屏模式</div>
                            <div class="settings-desc">移除手机边框，享受沉浸式体验</div>
                        </div>
                        <div class="settings-action">
                            <label class="toggle-switch">
                                <input type="checkbox" id="fullscreenToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item" onclick="openConfig('storage')">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">☁️
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">云存储设置</div>
                            <div class="settings-desc">配置Supabase Storage</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item" onclick="openBeautify()">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #ff9a9e, #fecfef);">🎨
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">美化</div>
                            <div class="settings-desc">自定义应用图标</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item" onclick="openWidgetManager()">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">📦
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">组件</div>
                            <div class="settings-desc">自定义桌面组件</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="config-page" id="apiConfig">
            <div class="settings-header">
                <div class="back-btn" onclick="closeApiConfig()">←</div>
                <div class="settings-title">API配置</div>
            </div>
            <div class="settings-content">
                <div class="section-title">已保存的配置</div>
                <div class="api-config-list" id="apiConfigList"></div>

                <div class="settings-section">
                    <div class="form-group">
                        <label class="form-label">配置名称</label>
                        <input type="text" class="form-input" id="configName" placeholder="例如: OpenAI GPT-4">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API URL</label>
                        <input type="text" class="form-input" id="apiUrl" placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="apiKey" placeholder="sk-...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">选择模型</label>
                        <select class="form-select" id="modelSelect">
                            <option value="">请先拉取模型列表</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="test-btn" onclick="testConnection()">测试连接</button>
                    <button class="fetch-btn" onclick="fetchModels()">拉取模型</button>
                </div>
                <div class="btn-group">
                    <button class="save-btn" onclick="saveApiConfig()">保存配置</button>
                </div>
                <div id="apiStatus" style="margin: 0 20px; font-size: 12px; color: #28a745; font-weight: 600;"></div>
            </div>
        </div>

        <div class="config-page" id="databaseConfig">
            <div class="settings-header">
                <div class="back-btn" onclick="closeConfig('database')">←</div>
                <div class="settings-title">数据库设置</div>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="form-group">
                        <label class="form-label">Supabase URL</label>
                        <input type="text" class="form-input" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Supabase Anon Key</label>
                        <input type="password" class="form-input" id="supabaseKey" placeholder="输入你的匿名密钥">
                    </div>
                    <div class="form-group">
                        <label class="form-label">表名称</label>
                        <input type="text" class="form-input" id="tableName" placeholder="例如: user_data"
                               value="user_data">
                    </div>
                </div>
                <button class="save-btn" onclick="saveConfig('database')" style="margin: 20px;">保存并初始化</button>
                <div id="dbStatus" style="margin: 0 20px; font-size: 12px; color: #28a745; font-weight: 600;"></div>
            </div>
        </div>

        <div class="config-page" id="storageConfig">
            <div class="settings-header">
                <div class="back-btn" onclick="closeConfig('storage')">←</div>
                <div class="settings-title">云存储设置</div>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="form-group">
                        <label class="form-label">Storage Bucket名称</label>
                        <input type="text" class="form-input" id="bucketName" placeholder="例如: icons" value="icons">
                    </div>
                    <div class="form-group">
                        <label class="form-label">文件上传路径</label>
                        <input type="text" class="form-input" id="uploadPath" placeholder="例如: app-icons/"
                               value="app-icons/">
                    </div>
                    <div class="form-group">
                        <label class="form-label">最大文件大小 (MB)</label>
                        <input type="number" class="form-input" id="maxFileSize" placeholder="5" value="5">
                    </div>
                </div>
                <button class="save-btn" onclick="saveConfig('storage')" style="margin: 20px;">保存配置</button>
                <div id="storageStatus"
                     style="margin: 0 20px; font-size: 12px; color: #28a745; font-weight: 600;"></div>
            </div>
        </div>

        <div class="beautify-page" id="beautifyPage">
            <div class="settings-header">
                <div class="back-btn" onclick="closeBeautify()">←</div>
                <div class="settings-title">美化</div>
            </div>
            <div class="settings-content">

                <div class="settings-section">
                    <div class="section-title">更换壁纸</div>
                    <div class="wallpaper-grid" id="wallpaperGrid">
                    </div>
                </div>
                <div class="settings-section" style="padding: 0 12px; margin-top: -8px;">
                    <div class="app-preview-item">
                        <div class="preview-header">
                            <div class="preview-icon">🖼️</div>
                            <div class="preview-name">自定义壁纸</div>
                        </div>
                        <div class="upload-section">
                            <label class="upload-btn">
                                📁 上传文件
                                <input type="file" class="file-input" accept="image/*"
                                       onchange="handleWallpaperUpload(event)">
                            </label>
                            <div class="url-input-btn" onclick="toggleWallpaperUrlInput()">🔗 URL填写</div>
                        </div>
                        <div class="url-input-box" id="wallpaper-url-box">
                            <input type="text" class="url-input-field" id="wallpaper-url-input"
                                   placeholder="输入图片URL">
                            <button class="confirm-btn" onclick="applyWallpaperFromUrl()">确认</button>
                        </div>
                        <div class="status-message" id="wallpaper-status"></div>
                    </div>
                </div>

                <div class="app-preview-list" id="appPreviewList">
                </div>

            </div>
        </div>
        <div class="config-page" id="widgetManager">
            <div class="settings-header">
                <div class="back-btn" onclick="closeWidgetManager()">←</div>
                <div class="settings-title">组件管理</div>
            </div>

            <div class="settings-content">
                <div class="section-title">自定义组件代码</div>

                <div style="padding: 0 20px;">
                    <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px; font-weight: 600;">
                            组件HTML代码
                        </div>
                        <textarea id="widgetCodeInput"
                                  style="width: 100%; min-height: 200px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; resize: vertical;"
                                  placeholder="示例代码：<div class='widget-scene'>
                            <div style='position: absolute; bottom: 20px; right: 30px; font-size: 60px;'>🌺</div>
                            </div>

                            可用CSS选择器：
                            .widget - 组件容器
                            .widget-time - 顶部文字
                            .widget-scene - 场景区域
                            支持常见CSS样式"></textarea>
                    </div>
                    <button class="save-btn" onclick="applyCustomWidget()"
                            style="width: 100%; margin-bottom: 16px;">应用组件
                    </button>
                </div>
            </div>
            <div class="section-title">已有组件</div>
            <div id="savedWidgetsList" style="padding: 0 20px;"></div>
        </div>
        <div class="contacts-page" id="contactsPage">
            <div class="contacts-header">
                <div class="back-btn" onclick="closeContacts()">←</div>
                <input type="text" class="contacts-search" id="contactsSearch" placeholder="搜索联系人..."
                       oninput="filterContacts()">
                <div class="add-contact-btn" onclick="toggleContactMenu(event)">+</div>

                <div class="contact-menu" id="contactMenu">
                    <div class="contact-menu-item" onclick="createNewContact()">新建联系人</div>
                    <div class="contact-menu-item" onclick="selectExistingContact()">选择已有联系人</div>
                </div>
            </div>
            <div class="contacts-list" id="contactsList"></div>
        </div>
        <div class="modal-overlay" id="characterCardModal">
            <div class="character-card-modal">
                <div class="character-card-content">
                    <div class="top-info-section">
                        <div class="character-avatar" onclick="openAvatarActions()">
                            <label for="avatar-input" style="width:100%; height:100%; cursor:pointer;">
                                <img id="avatar-preview" src="" alt="角色头像">
                            </label>
                            <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                        </div>
                        <div class="core-details">
                            <input type="text" id="char-name" placeholder="角色姓名">
                            <div class="character-gender-selection">
                                <label><input type="radio" name="gender" value="male" checked> 男</label>
                                <label><input type="radio" name="gender" value="female"> 女</label>
                                <label><input type="radio" name="gender" value="other"> 其他</label>
                            </div>
                            <div class="character-id">
                                <strong>ID:</strong> <span id="char-id">...</span>
                            </div>
                        </div>
                    </div>
                    <div class="persona-section">
                        <textarea id="char-persona" placeholder="在此处填写角色的背景故事..."></textarea>
                    </div>
                </div>
                <div class="character-card-footer">
                    <button class="character-card-btn cancel" onclick="closeCharacterCardPage()">取消</button>
                    <button class="character-card-btn save" onclick="saveCharacterCard()">保存</button>
                </div>
            </div>

            <div class="avatar-action-sheet" id="avatarActionSheet">
                <div class="action-sheet-backdrop" onclick="closeAvatarActions()"></div>
                <div class="action-sheet-options">
                    <div class="action-option" onclick="triggerFileUpload()">📁 从文件上传</div>
                    <div class="action-option" onclick="promptForUrl()">🔗 填写图片URL</div>
                    <div class="action-option cancel" onclick="closeAvatarActions()">取消</div>
                </div>
            </div>
        </div>

        <div class="chat-page" id="chatPage">
            <div class="chat-header">
                <div class="back-btn" onclick="closeChat()">←</div>
                <h2 class="chat-title" id="chatContactName"></h2> <!-- 将 div 改为 h2 更符合语义 -->

                <!-- 新增一个容器来包裹右侧的所有按钮 -->
                <div class="header-actions">
                    <div class="edit-contact-btn" onclick="editCurrentContact()">编辑</div>
                    <!-- 这就是我们新增的设置按钮 -->
                    <div class="chat-settings-btn" id="chatSettingsBtn" onclick="openChatSettings()">⚙️</div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
            </div>
            <div class="chat-input-area">
                <button class="chat-action-btn" id="showAttachmentMenuBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6Z"></path>
                    </svg>
                </button>

                <!-- 2. 这是点击加号后展开的菜单 (默认隐藏) -->
                <div class="attachment-menu" id="attachmentMenu">
                    <div class="attachment-item" id="uploadFileBtn">
                        <div class="attachment-icon">📁</div>
                        <div class="attachment-label">文件</div>
                    </div>
                    <div class="attachment-item" id="uploadImageBtn">
                        <div class="attachment-icon">🖼️</div>
                        <div class="attachment-label">图片</div>
                    </div>
                </div>

                <!-- 3. 这两个是隐藏的文件选择框，用户看不到，由 JS 触发 -->
                <input type="file" id="fileInput" style="display: none;">
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                <input type="text" id="chatInput" placeholder="输入消息...">
                <button class="chat-action-btn" id="addMsgBtn" onclick="addMessageToList()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6Z"></path>
                    </svg>
                </button>
                <button class="chat-action-btn primary" id="getReplyBtn" onclick="getAiReply()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M1.946 9.315c-.522-.174-.527-.455.01-.634l19.087-6.362c.529-.176.832.12.684.638l-5.454 19.086c-.15.529-.455.547-.679.045L12 14l6-8-8 6-8.054-2.685Z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="chat-settings-page" id="chatSettingsPage">
            <!-- 1. 顶部导航栏 -->
            <div class="settings-header">
                <div class="back-btn" onclick="closeChatSettings()">←</div>
                <div class="settings-title">聊天设置</div>
            </div>
            <!-- 2. 页面主要内容 -->
            <div class="settings-content">
                <div class="settings-section">
                    <div class="section-title">当前对话</div>
                    <!-- 3. 功能选项：清空记录 -->
                    <div class="settings-item" onclick="clearCurrentChatHistory()">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #ff758c, #ff7eb3);">
                            🗑️
                        </div>
                        <div class="settings-info">
                            <div class="settings-label">清空聊天记录</div>
                            <div class="settings-desc">删除与当前联系人的所有消息</div>
                        </div>
                        <div class="settings-arrow">›</div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <div class="settings-label">代码框滚动条</div>
                            <div class="settings-desc">开启后，过长的代码将出现水平滚动条</div>
                        </div>
                        <div class="settings-action">
                            <label class="toggle-switch">
                                <input type="checkbox" id="codeScrollToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="section-title">外观</div>
                        <div class="settings-section" style="padding: 0 20px; margin-bottom: 20px;">
                            <div class="form-group" style="padding: 10px;">
                                <label class="form-label" style="margin-bottom: 10px;">消息样式</label>
                                <div class="segmented-control" id="messageStyleSelector">
                                    <div class="segmented-option active" data-style="bubble">气泡</div>
                                    <div class="segmented-option" data-style="simple">简洁</div>
                                </div>
                            </div>
                        </div>
                        <!-- 更换聊天背景的设置项 -->
                        <div style="padding: 0 12px;">
                            <div class="app-preview-item">
                                <div class="preview-header">
                                    <div class="preview-icon">🖼️</div>
                                    <div class="preview-name">自定义聊天背景</div>
                                </div>
                                <div class="upload-section">
                                    <!-- 上传文件按钮 -->
                                    <label class="upload-btn">
                                        📁 上传文件
                                        <input type="file" class="file-input" accept="image/*"
                                               onchange="handleChatBgUpload(event)">
                                    </label>
                                    <!-- URL输入按钮 -->
                                    <div class="url-input-btn" onclick="toggleChatBgUrlInput()">🔗 URL填写</div>
                                </div>
                                <!-- URL输入框 (默认隐藏) -->
                                <div class="url-input-box" id="chat-bg-url-box">
                                    <input type="text" class="url-input-field" id="chat-bg-url-input"
                                           placeholder="输入图片URL">
                                    <button class="confirm-btn" onclick="applyChatBgFromUrl()">确认</button>
                                </div>
                                <!-- 状态消息提示 -->
                                <div class="status-message" id="chat-bg-status"></div>
                            </div>
                        </div>
                        <!-- 恢复默认背景的设置项 -->
                        <div class="settings-item" onclick="applyChatBackground('')">
                            <div class="settings-icon" style="background: #e9ecef;">
                                ✨
                            </div>
                            <div class="settings-info">
                                <div class="settings-label">恢复默认背景</div>
                                <div class="settings-desc">移除自定义聊天背景图</div>
                            </div>
                            <div class="settings-arrow">›</div>
                        </div>
                    </div>
                    <!-- 未来可以在这里添加更多设置项 -->
                </div>
            </div>
        </div>
        <div class="message-action-sheet" id="messageActionSheet">
            <div class="action-sheet-backdrop" onclick="hideMessageActionSheet()"></div>
            <div class="action-sheet-options">
                <!-- 选项将由JS动态添加，这里留一个 "删除" 按钮作为示例 -->
                <div class="action-option destructive" id="deleteMessageBtn">删除</div>
                <!-- 未来可以添加更多选项，如 "复制", "转发" 等 -->
                <div class="action-option cancel" onclick="hideMessageActionSheet()">取消</div>
            </div>
        </div>

        <script>
            const predefinedWallpapers = [
                'https://images.unsplash.com/photo-1570129477492-45c003edd2be?q=80&w=2070&auto=format&fit=crop',
                'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?q=80&w=1980&auto=format&fit=crop',
                'https://images.unsplash.com/photo-1554995207-c18c203602cb?q=80&w=2070&auto=format&fit=crop',
                'https://images.unsplash.com/photo-1580587771525-78b9dba3b914?q=80&w=1974&auto=format&fit=crop'
            ];

            function applyWallpaper(imageUrl) {
                const screenEl = document.getElementById('screen');
                if (!imageUrl) {
                    screenEl.style.backgroundImage = '';
                    localStorage.removeItem('phoneWallpaper');
                    console.log('壁纸已清除，恢复默认背景');
                } else {
                    screenEl.style.backgroundImage = `url('${imageUrl}')`;
                    localStorage.setItem('phoneWallpaper', imageUrl);
                    console.log('壁纸已应用并保存');
                }
                updateWallpaperActiveState(imageUrl);
            }

            function renderWallpaperThumbnails() {
                const grid = document.getElementById('wallpaperGrid');
                grid.innerHTML = '';

                predefinedWallpapers.forEach(url => {
                    const thumb = document.createElement('div');
                    thumb.className = 'wallpaper-thumbnail';
                    thumb.style.backgroundImage = `url('${url}')`;
                    thumb.dataset.url = url;
                    thumb.onclick = () => applyWallpaper(url);
                    grid.appendChild(thumb);
                });

                const noWallpaperThumb = document.createElement('div');
                noWallpaperThumb.className = 'wallpaper-thumbnail';
                noWallpaperThumb.style.background = 'linear-gradient(135deg, #ddd, #fff)';
                noWallpaperThumb.innerHTML = '<span style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:bold; color:#888; font-size:12px;">默认</span>';
                noWallpaperThumb.onclick = () => applyWallpaper('');
                grid.appendChild(noWallpaperThumb);
            }

            function updateWallpaperActiveState(currentUrl) {
                document.querySelectorAll('.wallpaper-thumbnail').forEach(thumb => {
                    if (!thumb.dataset.url && !currentUrl) {
                        thumb.classList.add('active');
                    } else {
                        thumb.classList.toggle('active', thumb.dataset.url === currentUrl);
                    }
                });
            }

            function handleWallpaperUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    applyWallpaper(e.target.result);
                    showWallpaperStatus('本地壁纸已应用');
                };
                reader.onerror = () => {
                    showWallpaperStatus('读取文件失败', 'error');
                };
                reader.readAsDataURL(file);
            }

            function toggleWallpaperUrlInput() {
                const urlBox = document.getElementById('wallpaper-url-box');
                urlBox.classList.toggle('show');
            }

            function applyWallpaperFromUrl() {
                const urlInput = document.getElementById('wallpaper-url-input');
                const url = urlInput.value.trim();
                if (url) {
                    applyWallpaper(url);
                    showWallpaperStatus('URL壁纸已应用');
                    urlInput.value = '';
                    toggleWallpaperUrlInput();
                } else {
                    showWallpaperStatus('请输入有效的URL', 'error');
                }
            }

            function showWallpaperStatus(message, type = 'success') {
                const statusEl = document.getElementById('wallpaper-status');
                statusEl.textContent = message;
                statusEl.className = 'status-message' + (type === 'error' ? ' error' : '');
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
            }

            function updateTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const timeStr = `${hours}:${minutes}`;

                const days = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
                const dayStr = days[now.getDay()];

                document.querySelectorAll('.status-bar span:first-child').forEach(el => {
                    el.textContent = timeStr;
                });

                const timeCard = document.querySelector('.time-card h2');
                if (timeCard) {
                    timeCard.textContent = timeStr;
                }

                const dayElement = document.querySelector('.time-card .day');
                if (dayElement) {
                    dayElement.textContent = dayStr;
                }
            }

            updateTime();
            setInterval(updateTime, 60000);
            updateBattery();
            updateLocation();
            const globalConfig = {
                apiConfigs: [],
                activeApiConfig: null,
                database: {
                    supabaseUrl: '',
                    supabaseKey: '',
                    tableName: 'user_data',
                    client: null
                },
                storage: {
                    bucketName: 'icons',
                    uploadPath: 'app-icons/',
                    maxFileSize: 5
                },
                customIcons: {},
                savedWidgets: [],
                dockIcons: ['💬', '🎵', '💬', '🱱']
            };

            function openCharacterCardPage() {
                const page = document.getElementById('characterCardModal');
                page.classList.add('show');

                document.getElementById('char-name').value = '';
                document.getElementById('char-persona').value = '';
                document.querySelector('.character-gender-selection input[value="male"]').checked = true;

                document.getElementById('avatar-preview').src = '';
                document.getElementById('avatar-input').value = '';

                document.getElementById('char-id').textContent = 'ID' + Math.floor(100000 + Math.random() * 900000);
            }


            function saveCharacterCard() {
                const name = document.getElementById('char-name').value.trim();
                const persona = document.getElementById('char-persona').value.trim();
                const gender = document.querySelector('input[name="gender"]:checked').value;
                const avatarSrc = document.getElementById('avatar-preview').src;
                const id = document.getElementById('char-id').textContent;

                if (!name) {
                    alert('姓名不能为空！');
                    return;
                }

                let finalAvatar = avatarSrc;
                if (!avatarSrc && !finalAvatar.includes('data:image')) {
                    if (gender === 'male') finalAvatar = '👨';
                    else if (gender === 'female') finalAvatar = '👩';
                    else finalAvatar = '👤';
                }

                const existingContact = contactsData.find(c => String(c.id) === String(id));

                if (existingContact) {
                    existingContact.name = name;
                    existingContact.status = persona || '这个角色很神秘，还没有设定...';
                    existingContact.avatar = finalAvatar;

                    if (currentChatContact && currentChatContact.id === existingContact.id) {
                        document.getElementById('chatContactName').textContent = name;
                    }
                    console.log('联系人已更新:', existingContact.name);

                } else {
                    const newContact = {
                        id: Date.now(),
                        name: name,
                        avatar: finalAvatar,
                        status: persona || '这个角色很神秘，还没有设定...',
                        badge: 0
                    };
                    contactsData.unshift(newContact);
                    console.log('新联系人已创建:', newContact.name);
                }

                renderContacts(contactsData);
                closeCharacterCardPage();
            }


            function closeCharacterCardPage() {
                const page = document.getElementById('characterCardModal');
                page.classList.remove('show');
            }


            document.getElementById('avatar-input').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('avatar-preview').src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });

            function escapeHTML(str) {
                if (!str) return '';
                return str.replace(/[&<>"']/g, function (match) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[match];
                });
            }

            let messageLongPressTimer = null; // 用于检测长按的计时器

            /**
             * 创建消息的DOM元素，并为其绑定长按/右键事件
             */
            /* --- 用这个全新版本替换旧的 _createMessageDOM 函数 --- */
            function _createMessageDOM(contactId, message, index) {
                const row = document.createElement('div');
                row.className = 'message-row ' + (message.sender === 'user' ? 'sent' : 'received');

                // === 新增：创建头像 ===
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-chat-avatar';

                let avatarSrc, senderName;
                if (message.sender === 'user') {
                    senderName = '你'; // 或者用户的名字
                    // 这里可以放用户的头像URL，暂时用占位符
                    avatarDiv.innerHTML = `<div class="initials" style="background: #0A84FF;">👤</div>`;
                } else {
                    senderName = currentChatContact.name;
                    avatarSrc = currentChatContact.avatar;
                    const isUrl = avatarSrc.startsWith('http') || avatarSrc.startsWith('data:');
                    if (isUrl) {
                        avatarDiv.innerHTML = `<img src="${avatarSrc}" alt="${senderName}">`;
                    } else {
                        avatarDiv.innerHTML = `<div class="initials" style="background: #6c757d;">${avatarSrc}</div>`;
                    }
                }

                // === 新增：创建内容容器 ===
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                // === 新增：创建发送者名字 ===
                const senderNameDiv = document.createElement('div');
                senderNameDiv.className = 'message-sender-name';
                senderNameDiv.textContent = senderName;

                // 创建消息气泡 (逻辑不变)
                const bubble = createMessageBubble(message.text);

                // 绑定长按/右键事件 (逻辑不变)
                bubble.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showMessageActionSheet(contactId, index);
                });
                bubble.addEventListener('touchstart', () => {
                    messageLongPressTimer = setTimeout(() => showMessageActionSheet(contactId, index), 500);
                });
                bubble.addEventListener('touchend', () => {
                    clearTimeout(messageLongPressTimer);
                });
                bubble.addEventListener('touchmove', () => {
                    clearTimeout(messageLongPressTimer);
                });

                // === 修改：组装新的DOM结构 ===
                // 将发送者名字和消息体放入内容容器
                contentDiv.appendChild(senderNameDiv);
                contentDiv.appendChild(bubble);

                // 将头像和内容容器放入消息行
                row.appendChild(avatarDiv);
                row.appendChild(contentDiv);

                return row;
            }


            /**
             * 显示消息操作菜单
             * @param {string|number} contactId - 联系人ID
             * @param {number} index - 消息的索引
             */
            function showMessageActionSheet(contactId, index) {
                const actionSheet = document.getElementById('messageActionSheet');
                const deleteBtn = document.getElementById('deleteMessageBtn');

                // 关键一步：将消息的身份信息存储在删除按钮上
                deleteBtn.dataset.contactId = contactId;
                deleteBtn.dataset.index = index;

                actionSheet.classList.add('show');
            }

            /**
             * 隐藏消息操作菜单
             */
            function hideMessageActionSheet() {
                const actionSheet = document.getElementById('messageActionSheet');
                actionSheet.classList.remove('show');
            }


            /**
             * 删除指定的消息 (现在由操作菜单调用)
             * @param {string|number} contactId - 联系人ID
             * @param {number} messageIndex - 消息的索引
             */
            function deleteMessage(contactId, messageIndex) {
                // 确认框仍然保留，作为最后一道防线
                if (confirm('确定要永久删除这条消息吗？')) {
                    const chatHistory = JSON.parse(localStorage.getItem('phoneChatHistory') || '{}');
                    if (chatHistory[contactId] && chatHistory[contactId][messageIndex] !== undefined) {
                        chatHistory[contactId].splice(messageIndex, 1);
                        localStorage.setItem('phoneChatHistory', JSON.stringify(chatHistory));
                        console.log(`消息已删除 (Contact: ${contactId}, Index: ${messageIndex})`);

                        // 重新渲染当前聊天界面
                        openChat(currentChatContact);
                        renderContacts(contactsData); // 更新联系人列表的最后消息
                    }
                }
            }

            // ========== 结束：替换代码 ==========


            /* --- 用这个全新的函数替换掉旧的 createMessageBubble 函数 --- */
            function createMessageBubble(text) {
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';

                const safeText = String(text || '');
                const codeBlockRegex = /```([\s\S]*?)```/g;
                let lastIndex = 0;
                let match;

                while ((match = codeBlockRegex.exec(safeText)) !== null) {
                    // 1. 添加代码块之前的所有普通文本
                    const precedingText = safeText.slice(lastIndex, match.index);
                    if (precedingText) {
                        bubble.appendChild(document.createTextNode(precedingText));
                    }

                    // 2. 创建代码块的核心部分
                    const codeContent = match[1].trim();

                    // 创建包裹容器
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';

                    // 创建 pre 和 code 标签
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    code.textContent = codeContent;
                    pre.appendChild(code);

                    // 创建复制按钮
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-code-btn';
                    // 使用 SVG 图标增加美观度
                    copyBtn.innerHTML = `
            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-5zm0 16H8V7h11v14z"></path></svg>
            <span>复制</span>
        `;

                    // 为按钮绑定点击事件
                    copyBtn.addEventListener('click', () => {
                        navigator.clipboard.writeText(codeContent).then(() => {
                            // 复制成功后的反馈
                            copyBtn.innerHTML = `
                   <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg>
                   <span>已复制!</span>
                `;
                            copyBtn.classList.add('copied');

                            // 2秒后恢复原样
                            setTimeout(() => {
                                copyBtn.innerHTML = `
                        <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-5zm0 16H8V7h11v14z"></path></svg>
                        <span>复制</span>
                    `;
                                copyBtn.classList.remove('copied');
                            }, 2000);

                        }).catch(err => {
                            console.error('复制失败: ', err);
                            copyBtn.textContent = '失败';
                            setTimeout(() => {
                                copyBtn.textContent = '复制';
                            }, 2000);
                        });
                    });

                    // 将 pre 和 button 添加到容器中
                    wrapper.appendChild(pre);
                    wrapper.appendChild(copyBtn);

                    // 将整个容器添加到消息气泡中
                    bubble.appendChild(wrapper);

                    lastIndex = codeBlockRegex.lastIndex;
                }

                // 3. 添加最后一个代码块之后的所有剩余文本
                const remainingText = safeText.slice(lastIndex);
                if (remainingText) {
                    bubble.appendChild(document.createTextNode(remainingText));
                }

                return bubble;
            }


            const contactsData = [
                {id: 1, name: '代码助手', avatar: '🤖', status: '为您服务'}
            ];

            let currentChatContact = null;

            async function updateBattery() {
                try {
                    if ('getBattery' in navigator) {
                        const battery = await navigator.getBattery();

                        const updateBatteryDisplay = () => {
                            const level = Math.round(battery.level * 100);
                            const charging = battery.charging;
                            document.querySelectorAll('.status-icons').forEach(iconGroup => {
                                const container = iconGroup.querySelector('.battery-container');
                                const levelBar = iconGroup.querySelector('.battery-level');
                                const text = iconGroup.querySelector('.battery-text');
                                if (container && levelBar && text) {
                                    text.textContent = `${level}%`;

                                    container.classList.toggle('charging', charging);

                                    levelBar.style.width = `${level * 0.85}%`;

                                    levelBar.classList.toggle('low', level <= 20 && !charging);
                                }
                            });

                            console.log(`电量已更新: ${level}% ${charging ? '(充电中)' : ''}`);
                        };

                        updateBatteryDisplay();

                        battery.addEventListener('levelchange', updateBatteryDisplay);
                        battery.addEventListener('chargingchange', updateBatteryDisplay);

                    } else {
                        console.warn('浏览器不支持 Battery API');
                    }
                } catch (error) {
                    console.error('获取电量失败:', error);
                }
            }


            async function updateLocation() {
                const locationElement = document.querySelector('.weather-card .location');
                if (!locationElement) return;

                try {
                    if (!navigator.geolocation) {
                        console.warn('浏览器不支持地理定位');
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;

                            console.log('位置坐标:', lat, lon);

                            try {
                                const response = await fetch(
                                    `https://restapi.amap.com/v3/geocode/regeo?location=${lon},${lat}&key=YOUR_AMAP_KEY&extensions=base`
                                );

                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.status === '1' && data.regeocode) {
                                        const address = data.regeocode.addressComponent;
                                        const district = address.district || address.city || '未知位置';
                                        locationElement.textContent = `${district} 🌺`;
                                        console.log('地址解析成功:', district);
                                        return;
                                    }
                                }
                            } catch (error) {
                                console.warn('高德API解析失败,使用备用方案');
                            }

                            try {
                                const response = await fetch(
                                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=zh-CN`
                                );

                                if (response.ok) {
                                    const data = await response.json();
                                    const address = data.address;
                                    const location = address.city || address.town || address.village ||
                                        address.county || address.state || '未知位置';
                                    locationElement.textContent = `${location} 🌺`;
                                    console.log('地址解析成功:', location);
                                }
                            } catch (error) {
                                console.error('地址解析失败:', error);
                                locationElement.textContent = `位置: ${lat.toFixed(2)}, ${lon.toFixed(2)} 🌺`;
                            }
                        },
                        (error) => {
                            console.warn('获取位置失败:', error.message);
                            if (error.code === 1) {
                                locationElement.textContent = '未授权定位 🌺';
                            } else {
                                locationElement.textContent = '定位失败 🌺';
                            }
                        },
                        {
                            enableHighAccuracy: false,
                            timeout: 10000,
                            maximumAge: 600000
                        }
                    );
                } catch (error) {
                    console.error('地理定位错误:', error);
                }
            }

            function toggleWeatherSelector(event) {
                event.stopPropagation();
                const popup = document.getElementById('weatherPopup');
                if (popup.style.display === 'none') {
                    popup.style.display = 'block';
                } else {
                    popup.style.display = 'none';
                }
            }

            function selectWeather(weatherType, event) {
                event.stopPropagation();

                const weatherIcons = {
                    sunny: '☀️',
                    cloudy: '☁️',
                    rainy: '🌧️',
                    snowy: '❄️'
                };

                const currentIcon = document.getElementById('currentWeatherIcon');
                if (currentIcon) {
                    currentIcon.textContent = weatherIcons[weatherType];
                }

                document.querySelectorAll('.weather-option').forEach(option => {
                    option.classList.remove('active');
                });

                const selectedOption = document.querySelector(`[data-weather="${weatherType}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('active');
                }

                localStorage.setItem('selectedWeather', weatherType);

                document.getElementById('weatherPopup').style.display = 'none';

                console.log(`已选择天气: ${weatherType}`);
            }

            function editMood(event) {
                event.stopPropagation();

                const moodTextEl = document.getElementById('moodText');
                const currentMood = moodTextEl.classList.contains('empty') ? '' : moodTextEl.textContent;

                const newMood = prompt('输入你的心情：', currentMood);

                if (newMood !== null) {
                    if (newMood.trim() === '') {
                        moodTextEl.textContent = '点击填写心情...';
                        moodTextEl.classList.add('empty');
                    } else {
                        moodTextEl.textContent = newMood.trim();
                        moodTextEl.classList.remove('empty');
                    }

                    localStorage.setItem('userMood', newMood.trim());
                }
            }

            function loadSavedMoodAndWeather() {
                const weatherIcons = {
                    sunny: '☀️',
                    cloudy: '☁️',
                    rainy: '🌧️',
                    snowy: '❄️'
                };

                const savedMood = localStorage.getItem('userMood');
                const moodTextEl = document.getElementById('moodText');
                if (savedMood && moodTextEl) {
                    moodTextEl.textContent = savedMood;
                    moodTextEl.classList.remove('empty');
                }

                const savedWeather = localStorage.getItem('selectedWeather') || 'sunny';
                const currentIcon = document.getElementById('currentWeatherIcon');
                if (currentIcon) {
                    currentIcon.textContent = weatherIcons[savedWeather];
                }

                document.querySelectorAll('.weather-option').forEach(option => {
                    option.classList.remove('active');
                });
                const selectedOption = document.querySelector(`[data-weather="${savedWeather}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('active');
                }
            }

            document.addEventListener('click', function (e) {
                const popup = document.getElementById('weatherPopup');
                const weatherDisplay = document.querySelector('.weather-display');
                if (popup && !popup.contains(e.target) && !weatherDisplay.contains(e.target)) {
                    popup.style.display = 'none';
                }
            });

            function initSupabaseClient() {
                const {supabaseUrl, supabaseKey} = globalConfig.database;

                if (!supabaseUrl || !supabaseKey) {
                    return null;
                }

                globalConfig.database.client = {
                    from: (table) => ({
                        select: () => Promise.resolve({data: [], error: null}),
                        insert: (data) => Promise.resolve({data, error: null}),
                        update: (data) => Promise.resolve({data, error: null}),
                        delete: () => Promise.resolve({data: null, error: null})
                    }),
                    storage: {
                        from: (bucket) => ({
                            upload: (path, file) => {
                                console.log(`上传文件到: ${bucket}/${path}`);
                                return Promise.resolve({
                                    data: {path: `${bucket}/${path}`},
                                    error: null
                                });
                            },
                            getPublicUrl: (path) => ({
                                data: {publicUrl: `https://example.supabase.co/storage/v1/object/public/${path}`}
                            })
                        })
                    }
                };

                return globalConfig.database.client;
            }

            const dbAPI = {
                async saveData(data) {
                    if (!globalConfig.database.client) {
                        console.warn('数据库未初始化，请先配置Supabase');
                        return {success: false, message: '数据库未初始化'};
                    }

                    try {
                        const {data: result, error} = await globalConfig.database.client
                            .from(globalConfig.database.tableName)
                            .insert(data);

                        if (error) throw error;
                        return {success: true, data: result};
                    } catch (error) {
                        console.error('保存数据失败:', error);
                        return {success: false, message: error.message};
                    }
                },

                async getData(filters = {}) {
                    if (!globalConfig.database.client) {
                        console.warn('数据库未初始化');
                        return {success: false, data: []};
                    }

                    try {
                        const {data, error} = await globalConfig.database.client
                            .from(globalConfig.database.tableName)
                            .select();

                        if (error) throw error;
                        return {success: true, data};
                    } catch (error) {
                        console.error('获取数据失败:', error);
                        return {success: false, data: []};
                    }
                }
            };

            const storageAPI = {
                async uploadFile(file, customPath = '') {
                    if (!globalConfig.database.client) {
                        console.warn('云存储未初始化，请先配置Supabase');
                        return {success: false, url: null};
                    }

                    try {
                        const {bucketName, uploadPath} = globalConfig.storage;
                        const filePath = `${uploadPath}${customPath || file.name}`;

                        const {data, error} = await globalConfig.database.client.storage
                            .from(bucketName)
                            .upload(filePath, file);

                        if (error) throw error;

                        const {data: urlData} = globalConfig.database.client.storage
                            .from(bucketName)
                            .getPublicUrl(filePath);

                        console.log('文件上传成功:', urlData.publicUrl);
                        return {success: true, url: urlData.publicUrl};
                    } catch (error) {
                        console.error('文件上传失败:', error);
                        return {success: false, url: null, message: error.message};
                    }
                }
            };

            const appsPage1 = [
                {id: 'qq', icon: '🧊', label: 'QQ', row: 0, col: 0},
                {id: 'photo', icon: '📷', label: '相册', row: 0, col: 1},
                {id: 'calc', icon: '➕', label: '计算器', row: 0, col: 2},
                {id: 'store', icon: '🪐', label: '应用商店', row: 0, col: 3},
                {id: 'settings', icon: '⚙️', label: '设置', row: 1, col: 0, clickable: true},
                {id: 'calendar', icon: '📅', label: '日历', row: 1, col: 1},
                {id: 'note', icon: '📝', label: '笔记', row: 1, col: 2},
                {id: 'clock', icon: '⏰', label: '时钟', row: 1, col: 3}
            ];


            // ========== 开始：粘贴这段修改后的代码 ==========
            const appsPage2 = [
                {
                    id: 'sys',
                    label: '系统应用',
                    isFolder: true,
                    icons: ['📱', '🎮', '🎯', '🐱', '🎨', '💫'],
                    row: 0,
                    col: 0
                },
                {
                    id: 'video',
                    label: 'video',
                    isFolder: true,
                    icons: ['📺', '🎬', '🎭'],
                    row: 0,
                    col: 1
                },
                {id: 'news', label: '新闻资讯', isFolder: true, icons: ['📰', '📖', '📱'], row: 0, col: 2},
                {
                    id: 'novel',
                    label: 'novel',
                    isFolder: true,
                    icons: ['📚', '📕', '📗'],
                    row: 1,
                    col: 0
                },
                {id: 'study', label: 'study', isFolder: true, icons: ['✏️', '📓', '🎓'], row: 1, col: 1},
                {
                    id: 'widget2',
                    label: 'Widget',
                    isWidget: true,
                    row: 2,
                    col: 0,
                    colspan: 4,
                    rowspan: 2
                },
                {
                    id: 'entertainment',
                    label: 'entertainment',
                    isFolder: true,
                    icons: ['🎮', '🎯', '🎪'],
                    row: 4,
                    col: 0
                },
                {
                    id: 'picture',
                    label: 'picture',
                    isFolder: true,
                    icons: ['🖼️', '🎨', '📷'],
                    row: 4,
                    col: 1
                },
                {
                    id: 'home',
                    label: '居家生活',
                    isFolder: true,
                    icons: ['🏠', '🛒', '🍜'],
                    row: 4,
                    col: 2
                },
                {
                    id: 'purchase',
                    label: 'purchase',
                    isFolder: true,
                    icons: ['🛍️', '💳', '🎁'],
                    row: 4,
                    col: 3
                }
            ];
            // ========== 结束：粘贴修改后的代码 ==========


            const state = {
                currentPage: 1,
                draggedElement: null,
                isDragging: false,
                isEditMode: false,
                hasDragged: false,
                dragStart: {x: 0, y: 0},
                dragOffset: {x: 0, y: 0},
                longPressTimer: null,
                swipeStart: {x: 0, time: 0},
                isSwipingPage: false,
                initialTransform: 0,
                appLayouts: {
                    page1: appsPage1,
                    page2: appsPage2
                }
            };


            const screen = document.getElementById('screen');
            const pagesWrapper = document.getElementById('pagesWrapper');

            const getTouch = (e) => e.touches?.[0] || e;
            const getChangedTouch = (e) => e.changedTouches?.[0] || e;

            function positionElement(el, row, col, colspan = 1, rowspan = 1) {
                const ROW_HEIGHT_PX = 94;
                const GAP_PX = 14;
                const leftPercent = col * 25;
                const widthPercent = colspan * 25;
                const topPx = row * (ROW_HEIGHT_PX + GAP_PX);
                const heightPx = (rowspan * ROW_HEIGHT_PX) + ((rowspan - 1) * GAP_PX);
                Object.assign(el.style, {
                    left: `${leftPercent}%`,
                    width: `${widthPercent}%`,
                    top: `${topPx}px`,
                    height: `${heightPx}px`
                });
            }


            function showEditHint(show) {
                const hint = document.getElementById(state.currentPage === 1 ? 'editHint1' : 'editHint2');
                hint.classList.toggle('show', show);
            }

            function showDeleteButtons(show) {
                const timeCard = document.getElementById('timeCard');
                if (timeCard) {
                    timeCard.classList.toggle('show-delete', show);
                }

                const weatherCard = document.getElementById('weatherCard');
                if (weatherCard) {
                    weatherCard.classList.toggle('show-delete', show);
                }

                document.querySelectorAll('.widget').forEach(widget => {
                    widget.classList.toggle('show-delete', show);
                });
            }

            function exitEditMode() {
                if (state.isEditMode && !state.isDragging) {
                    state.isEditMode = false;
                    showEditHint(false);
                    showDeleteButtons(false);
                    state.hasDragged = false;
                }
            }

            function openSettings() {
                document.getElementById('settingsPage').classList.add('show');
            }

            function closeSettings() {
                document.getElementById('settingsPage').classList.remove('show');
            }

            function openApiConfig() {
                document.getElementById('apiConfig').classList.add('show');
                renderApiConfigs();
            }

            function closeApiConfig() {
                document.getElementById('apiConfig').classList.remove('show');
            }

            function renderApiConfigs() {
                const list = document.getElementById('apiConfigList');
                list.innerHTML = '';

                globalConfig.apiConfigs.forEach((config, index) => {
                    const item = document.createElement('div');
                    item.className = 'api-config-item';
                    if (globalConfig.activeApiConfig === index) {
                        item.classList.add('active');
                    }

                    item.innerHTML = `
            <div class="config-details">
                <div class="config-name">${config.name}</div>
                <div class="config-url">${config.url}</div>
            </div>
            <button class="delete-config-btn" title="删除这个配置">×</button>
        `;

                    item.querySelector('.config-details').onclick = () => applyApiConfig(index);

                    const deleteBtn = item.querySelector('.delete-config-btn');
                    deleteBtn.onclick = (event) => {
                        event.stopPropagation();
                        deleteApiConfig(index);
                    };

                    list.appendChild(item);
                });

                const addBtn = document.createElement('button');
                addBtn.className = 'add-new-btn';
                addBtn.textContent = '+ 新增配置';
                addBtn.onclick = () => {
                    if (globalConfig.activeApiConfig !== null) {
                        document.querySelector('.api-config-item.active')?.classList.remove('active');
                        globalConfig.activeApiConfig = null;
                        saveGlobalConfig();
                    }
                    clearApiForm();
                };
                list.appendChild(addBtn);
            }


            function clearApiForm() {
                document.getElementById('configName').value = '';
                document.getElementById('apiUrl').value = '';
                document.getElementById('apiKey').value = '';
                document.getElementById('modelSelect').innerHTML = '<option value="">请先拉取模型列表</option>';
                showApiStatus('', '');
            }

            async function testConnection() {
                const url = document.getElementById('apiUrl').value;
                const key = document.getElementById('apiKey').value;

                if (!url || !key) {
                    showApiStatus('请填写URL和Key', 'error');
                    return;
                }

                showApiStatus('正在测试连接...', '');

                setTimeout(() => {
                    showApiStatus('连接成功', 'success');
                }, 1000);
            }

            async function fetchModels() {
                const url = document.getElementById('apiUrl').value.trim();
                const key = document.getElementById('apiKey').value.trim();

                if (!url || !key) {
                    showApiStatus('请填写有效的API URL和API Key', 'error');
                    return;
                }

                showApiStatus('正在向服务器请求模型列表...', '');
                const modelSelect = document.getElementById('modelSelect');
                modelSelect.innerHTML = '<option value="">正在拉取...</option>';
                modelSelect.disabled = true;

                try {
                    const response = await fetch(`${url}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${key}`
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMessage = errorData?.error?.message || `服务器返回错误: ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();

                    const models = (data.data || data).map(model => model.id).filter(id => id);

                    if (models.length > 0) {
                        modelSelect.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                        showApiStatus(`成功拉取 ${models.length} 个模型！`, 'success');
                    } else {
                        modelSelect.innerHTML = '<option value="">未找到可用模型</option>';
                        showApiStatus('API连接成功，但未返回任何模型列表。', 'error');
                    }

                } catch (error) {
                    console.error('拉取模型失败:', error);
                    modelSelect.innerHTML = '<option value="">拉取失败</option>';
                    showApiStatus(`拉取失败: ${error.message}。请检查URL、Key和网络连接。`, 'error');
                } finally {
                    modelSelect.disabled = false;
                }
            }


            function saveApiConfig() {
                const name = document.getElementById('configName').value.trim();
                const url = document.getElementById('apiUrl').value.trim();
                const key = document.getElementById('apiKey').value.trim();
                const model = document.getElementById('modelSelect').value;

                if (!name || !url || !key) {
                    showApiStatus('请填写所有必填项', 'error');
                    return;
                }

                const configData = {name, url, key, model};

                if (globalConfig.activeApiConfig !== null && globalConfig.apiConfigs[globalConfig.activeApiConfig]) {
                    globalConfig.apiConfigs[globalConfig.activeApiConfig] = configData;
                    showSuccessModal('更新成功', `配置 "${name}" 已被更新！`);
                } else {
                    globalConfig.apiConfigs.push(configData);
                    globalConfig.activeApiConfig = globalConfig.apiConfigs.length - 1;
                    showSuccessModal('保存成功', `配置 "${name}" 已被添加并激活！`);
                }

                saveGlobalConfig();
                renderApiConfigs();
            }


            function applyApiConfig(index) {
                globalConfig.activeApiConfig = index;
                const config = globalConfig.apiConfigs[index];

                document.getElementById('configName').value = config.name;
                document.getElementById('apiUrl').value = config.url;
                document.getElementById('apiKey').value = config.key;
                if (config.model) {
                    document.getElementById('modelSelect').innerHTML = `<option value="${config.model}">${config.model}</option>`;
                }

                showApiStatus(`已应用配置: ${config.name}`, 'success');
                renderApiConfigs();
            }

            function showApiStatus(message, type) {
                const status = document.getElementById('apiStatus');
                status.textContent = message;
                status.style.color = type === 'error' ? '#dc3545' : '#28a745';
            }

            function openConfig(type) {
                const configId = type === 'database' ? 'databaseConfig' : 'storageConfig';
                document.getElementById(configId).classList.add('show');

                if (type === 'database') {
                    document.getElementById('supabaseUrl').value = globalConfig.database.supabaseUrl;
                    document.getElementById('supabaseKey').value = globalConfig.database.supabaseKey;
                    document.getElementById('tableName').value = globalConfig.database.tableName;
                } else {
                    document.getElementById('bucketName').value = globalConfig.storage.bucketName;
                    document.getElementById('uploadPath').value = globalConfig.storage.uploadPath;
                    document.getElementById('maxFileSize').value = globalConfig.storage.maxFileSize;
                }
            }

            function closeConfig(type) {
                const configId = type === 'database' ? 'databaseConfig' : 'storageConfig';
                document.getElementById(configId).classList.remove('show');
            }

            function saveConfig(type) {
                if (type === 'database') {
                    globalConfig.database.supabaseUrl = document.getElementById('supabaseUrl').value;
                    globalConfig.database.supabaseKey = document.getElementById('supabaseKey').value;
                    globalConfig.database.tableName = document.getElementById('tableName').value;

                    const client = initSupabaseClient();
                    if (client) {
                        const status = document.getElementById('dbStatus');
                        status.textContent = '数据库已初始化，可以使用 dbAPI 进行操作';
                        status.style.color = '#28a745';

                        console.log('Supabase已初始化！');
                        console.log('使用方法：');
                        console.log('1. 保存数据: await dbAPI.saveData({ key: "value" })');
                        console.log('2. 获取数据: await dbAPI.getData()');
                    } else {
                        const status = document.getElementById('dbStatus');
                        status.textContent = '请填写完整的URL和Key';
                        status.style.color = '#dc3545';
                    }
                } else {
                    globalConfig.storage.bucketName = document.getElementById('bucketName').value;
                    globalConfig.storage.uploadPath = document.getElementById('uploadPath').value;
                    globalConfig.storage.maxFileSize = document.getElementById('maxFileSize').value;

                    const status = document.getElementById('storageStatus');
                    status.textContent = '云存储配置已保存，上传文件时自动使用此配置';
                    status.style.color = '#28a745';

                    console.log('云存储已配置！');
                    console.log('使用方法：');
                    console.log('await storageAPI.uploadFile(file, "custom-path.png")');
                }

                setTimeout(() => closeConfig(type), 2000);
            }

            function openBeautify() {
                document.getElementById('beautifyPage').classList.add('show');
                renderAppPreviews();
                renderWallpaperThumbnails();
                const currentWallpaper = localStorage.getItem('phoneWallpaper');
                updateWallpaperActiveState(currentWallpaper);
            }


            function closeBeautify() {
                document.getElementById('beautifyPage').classList.remove('show');
            }

            function openWidgetManager() {
                document.getElementById('widgetManager').classList.add('show');
                renderSavedWidgets();
            }

            function closeWidgetManager() {
                document.getElementById('widgetManager').classList.remove('show');
            }

            function renderSavedWidgets() {
                const container = document.getElementById('savedWidgetsList');
                container.innerHTML = '';

                if (globalConfig.savedWidgets.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">暂无已删除的组件</div>';
                    return;
                }

                globalConfig.savedWidgets.forEach((widget, index) => {
                    const item = document.createElement('div');
                    item.className = 'saved-widget-item';
                    item.innerHTML = `
                    <div class="saved-widget-name">${widget.name}</div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="restore-btn" onclick="restoreWidget(${index})">恢复到桌面</button>
                        <button class="delete-saved-btn" onclick="deleteSavedWidget(${index})">永久删除</button>
                    </div>
                `;
                    container.appendChild(item);
                });
            }

            function restoreWidget(index) {
                const widget = globalConfig.savedWidgets[index];
                if (!widget) return;

                if (widget.type === 'time') {
                    const section = document.querySelector('.time-weather-section');
                    section.insertAdjacentHTML('afterbegin', widget.html);
                } else if (widget.type === 'weather') {
                    const section = document.querySelector('.time-weather-section');
                    const timeCard = document.getElementById('timeCard');
                    if (timeCard) {
                        timeCard.insertAdjacentHTML('afterend', widget.html);
                    } else {
                        section.insertAdjacentHTML('beforeend', widget.html);
                    }
                } else if (widget.type === 'widget') {
                    const pageNum = widget.id.includes('widget2') ? 2 : 1;
                    const grid = document.getElementById(`grid${pageNum}`);
                    grid.insertAdjacentHTML('beforeend', widget.html);

                    const restoredElement = grid.querySelector(`[data-id="${widget.id}"]`);
                    if (restoredElement) {
                        addDragListeners(restoredElement, false);
                    }
                }

                const deletedComponents = JSON.parse(localStorage.getItem('deletedComponents') || '[]');
                const componentIndex = deletedComponents.indexOf(widget.id);

                if (componentIndex > -1) {
                    deletedComponents.splice(componentIndex, 1);
                }

                globalConfig.savedWidgets.splice(index, 1);

                try {
                    localStorage.setItem('deletedComponents', JSON.stringify(deletedComponents));
                    localStorage.setItem('savedWidgets', JSON.stringify(globalConfig.savedWidgets));
                    console.log(`${widget.name} 已恢复到桌面`);
                } catch (e) {
                    console.error('保存数据失败:', e);
                }

                renderSavedWidgets();
            }

            function deleteSavedWidget(index) {
                const widget = globalConfig.savedWidgets[index];
                if (!widget) return;

                if (confirm(`确定要永久删除"${widget.name}"吗？此操作无法撤销。`)) {
                    globalConfig.savedWidgets.splice(index, 1);

                    localStorage.setItem('savedWidgets', JSON.stringify(globalConfig.savedWidgets));

                    renderSavedWidgets();

                    console.log(`${widget.name} 已永久删除`);
                }
            }

            function openContacts() {
                document.getElementById('contactsPage').classList.add('show');
                renderContacts(contactsData);
            }

            function closeContacts() {
                document.getElementById('contactsPage').classList.remove('show');
                document.getElementById('contactsSearch').value = '';
            }

            function renderContacts(contacts) {
                const container = document.getElementById('contactsList');
                const chatHistory = JSON.parse(localStorage.getItem('phoneChatHistory') || '{}');

                container.innerHTML = '';
                if (contacts.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">未找到联系人</div>';
                    return;
                }

                contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'contact-item';

                    const contactMessages = chatHistory[contact.id] || [];
                    let lastMessageText = contact.status;
                    if (contactMessages.length > 0) {
                        lastMessageText = contactMessages[contactMessages.length - 1].text;
                    }

                    const isUrl = contact.avatar.startsWith('http') || contact.avatar.startsWith('data:');
                    const avatarContent = isUrl
                        ? `<img src="${contact.avatar}" class="contact-avatar" alt="${contact.name}">`
                        : `<div class="contact-avatar">${contact.avatar}</div>`;

                    item.innerHTML = `
            ${avatarContent}
            <div class="contact-info">
                <div class="contact-name">${contact.name}</div>
                <div class="contact-status">${lastMessageText}</div>
            </div>
            ${contact.badge > 0 ? `<div class="contact-badge">${contact.badge}</div>` : ''}
        `;

                    item.style.cursor = 'pointer';
                    item.onclick = () => openChat(contact);
                    container.appendChild(item);
                });
            }


            function filterContacts() {
                const searchText = document.getElementById('contactsSearch').value.toLowerCase();
                const filtered = contactsData.filter(contact =>
                    contact.name.toLowerCase().includes(searchText)
                );
                renderContacts(filtered);
            }

            function toggleContactMenu(event) {
                event.stopPropagation();
                const menu = document.getElementById('contactMenu');
                menu.classList.toggle('show');
            }

            function createNewContact() {
                const menu = document.getElementById('contactMenu');
                menu.classList.remove('show');
                openCharacterCardPage();
            }

            function selectExistingContact() {
                const menu = document.getElementById('contactMenu');
                menu.classList.remove('show');
                alert('打开选择已有联系人页面');
            }

            document.addEventListener('click', function (e) {
                const menu = document.getElementById('contactMenu');
                const addBtn = document.querySelector('.add-contact-btn');

                if (menu && addBtn && !menu.contains(e.target) && !addBtn.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });

            function applyCustomWidget() {
                const code = document.getElementById('widgetCodeInput').value.trim();

                if (!code) {
                    alert('请输入组件代码');
                    return;
                }

                const targetWidget = document.querySelector('[data-id="widget2"]');

                if (!targetWidget) {
                    alert('未找到目标 Widget，请先恢复原始组件');
                    return;
                }

                const alreadySaved = globalConfig.savedWidgets.some(w => w.id === 'widget2');

                if (!alreadySaved) {
                    globalConfig.savedWidgets.push({
                        id: 'widget2',
                        type: 'widget',
                        name: 'Widget（原始）',
                        html: targetWidget.outerHTML,
                        timestamp: Date.now()
                    });

                    localStorage.setItem('savedWidgets', JSON.stringify(globalConfig.savedWidgets));
                    console.log('原始 Widget 已保存到"已删除组件"列表');
                }

                const widgetScene = targetWidget.querySelector('.widget-scene');
                if (widgetScene) {
                    widgetScene.innerHTML = code;
                    alert('自定义组件已应用！');
                    console.log('自定义组件代码已应用到桌面');
                } else {
                    alert('Widget 结构异常，请检查');
                }
            }

            function renderAppPreviews() {
                const container = document.getElementById('appPreviewList');
                container.innerHTML = '';

                const dockSection = document.createElement('div');
                dockSection.innerHTML = '<div class="section-title">DOCK栏图标</div>';
                container.appendChild(dockSection);

                for (let i = 0; i < 4; i++) {
                    const item = document.createElement('div');
                    item.className = 'app-preview-item';

                    const currentIcon = globalConfig.dockIcons[i];
                    const isUrl = currentIcon.startsWith('http') || currentIcon.startsWith('data:');
                    const iconDisplay = isUrl
                        ? `<img src="${currentIcon}" alt="Dock ${i + 1}">`
                        : currentIcon;

                    item.innerHTML = `
            <div class="preview-header">
                <div class="preview-icon" id="preview-dock-${i}">
                    ${iconDisplay}
                </div>
                <div class="preview-name">Dock 图标 ${i + 1}</div>
            </div>
            <div class="upload-section">
                <label class="upload-btn">
                    📁 上传文件
                    <input type="file" class="file-input" accept="image/*" onchange="handleDockUpload(event, ${i})">
                </label>
                <div class="url-input-btn" onclick="toggleDockUrlInput(${i})">🔗 URL填写</div>
            </div>
            <div class="url-input-box" id="dock-url-box-${i}">
                <input type="text" class="url-input-field" id="dock-url-input-${i}" placeholder="输入图片URL">
                <button class="confirm-btn" onclick="applyDockUrl(${i})">确认</button>
            </div>
            <div class="status-message" id="dock-status-${i}"></div>
        `;

                    container.appendChild(item);
                }

                const divider = document.createElement('div');
                divider.innerHTML = '<div class="section-title">应用图标</div>';
                container.appendChild(divider);

                const allApps = [...appsPage1.filter(app => !app.isWidget), ...appsPage2.filter(app => !app.isWidget && !app.isFolder)];

                allApps.forEach(app => {
                    const item = document.createElement('div');
                    item.className = 'app-preview-item';

                    const customIcon = globalConfig.customIcons[app.id];
                    const iconDisplay = customIcon
                        ? `<img src="${customIcon}" alt="${app.label}">`
                        : app.icon;

                    item.innerHTML = `
                    <div class="preview-header">
                        <div class="preview-icon" id="preview-${app.id}">
                            ${iconDisplay}
                        </div>
                        <div class="preview-name">${app.label}</div>
                    </div>
                    <div class="upload-section">
                        <label class="upload-btn">
                            📁 上传文件
                            <input type="file" class="file-input" accept="image/*" onchange="handleFileUpload(event, '${app.id}')">
                        </label>
                        <div class="url-input-btn" onclick="toggleUrlInput('${app.id}')">🔗 URL填写</div>
                    </div>
                    <div class="url-input-box" id="url-box-${app.id}">
                        <input type="text" class="url-input-field" id="url-input-${app.id}" placeholder="输入图片URL">
                        <button class="confirm-btn" onclick="applyUrlIcon('${app.id}')">确认</button>
                    </div>
                    <div class="status-message" id="status-${app.id}"></div>
                `;

                    container.appendChild(item);
                });
            }

            function toggleUrlInput(appId) {
                const urlBox = document.getElementById(`url-box-${appId}`);
                urlBox.classList.toggle('show');
            }

            async function handleFileUpload(event, appId) {
                const file = event.target.files[0];
                if (!file) return;

                const maxSize = globalConfig.storage.maxFileSize * 1024 * 1024;
                if (file.size > maxSize) {
                    showStatus(appId, `文件太大 最大${globalConfig.storage.maxFileSize}MB`, 'error');
                    return;
                }

                if (globalConfig.database.client) {
                    showStatus(appId, '正在上传到云存储...', '');
                    const result = await storageAPI.uploadFile(file, `${appId}-${Date.now()}.${file.name.split('.').pop()}`);

                    if (result.success) {
                        applyCustomIcon(appId, result.url);
                        showStatus(appId, '已上传到云存储');
                    } else {
                        showStatus(appId, '上传失败，使用本地预览', 'error');
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            applyCustomIcon(appId, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        applyCustomIcon(appId, e.target.result);
                        showStatus(appId, '文件已加载（本地预览）');
                    };
                    reader.readAsDataURL(file);
                }
            }

            function applyUrlIcon(appId) {
                const urlInput = document.getElementById(`url-input-${appId}`);
                const url = urlInput.value.trim();

                if (!url) {
                    showStatus(appId, '请输入URL', 'error');
                    return;
                }

                applyCustomIcon(appId, url);
                showStatus(appId, 'URL图标已应用');
                urlInput.value = '';
                toggleUrlInput(appId);
            }

            function applyCustomIcon(appId, iconUrl) {
                globalConfig.customIcons[appId] = iconUrl;

                const previewEl = document.getElementById(`preview-${appId}`);
                previewEl.innerHTML = `<img src="${iconUrl}" alt="">`;

                updateMainIcon(appId, iconUrl);
                saveCustomIconsToLocalStorage();
                console.log(`已将 ${appId} 的新图标保存到 LocalStorage`);
                if (globalConfig.database.client) {
                    dbAPI.saveData({
                        app_id: appId,
                        icon_url: iconUrl,
                        updated_at: new Date().toISOString()
                    }).then(result => {
                        if (result.success) {
                            console.log(`图标配置已同步到数据库: ${appId}`);
                        }
                    });
                }
            }

            function toggleDockUrlInput(index) {
                const urlBox = document.getElementById(`dock-url-box-${index}`);
                urlBox.classList.toggle('show');
            }

            async function handleDockUpload(event, index) {
                const file = event.target.files[0];
                if (!file) return;

                const maxSize = globalConfig.storage.maxFileSize * 1024 * 1024;
                if (file.size > maxSize) {
                    showDockStatus(index, `文件太大 最大${globalConfig.storage.maxFileSize}MB`, 'error');
                    return;
                }

                if (globalConfig.database.client) {
                    showDockStatus(index, '正在上传到云存储...', '');
                    const result = await storageAPI.uploadFile(file, `dock-${index}-${Date.now()}.${file.name.split('.').pop()}`);

                    if (result.success) {
                        applyDockIcon(index, result.url);
                        showDockStatus(index, '已上传到云存储');
                    } else {
                        showDockStatus(index, '上传失败,使用本地预览', 'error');
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            applyDockIcon(index, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        applyDockIcon(index, e.target.result);
                        showDockStatus(index, '文件已加载(本地预览)');
                    };
                    reader.readAsDataURL(file);
                }
            }

            function applyDockUrl(index) {
                const urlInput = document.getElementById(`dock-url-input-${index}`);
                const url = urlInput.value.trim();

                if (!url) {
                    showDockStatus(index, '请输入URL', 'error');
                    return;
                }

                applyDockIcon(index, url);
                showDockStatus(index, 'URL图标已应用');
                urlInput.value = '';
                toggleDockUrlInput(index);
            }

            function applyDockIcon(index, iconUrl) {
                globalConfig.dockIcons[index] = iconUrl;

                const previewEl = document.getElementById(`preview-dock-${index}`);
                if (previewEl) {
                    previewEl.innerHTML = `<img src="${iconUrl}" alt="">`;
                }

                const dockIcon = document.querySelectorAll('.dock-icon')[index];
                if (dockIcon) {
                    dockIcon.innerHTML = `<img src="${iconUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 14px;" alt="">`;
                }

                localStorage.setItem('phoneDockIcons', JSON.stringify(globalConfig.dockIcons));
                console.log(`Dock图标 ${index} 已保存`);
            }

            function showDockStatus(index, message, type = 'success') {
                const statusEl = document.getElementById(`dock-status-${index}`);
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = 'status-message' + (type === 'error' ? ' error' : '');
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                }
            }


            function updateMainIcon(appId, iconUrl) {
                const appElements = document.querySelectorAll(`[data-id="${appId}"]`);
                appElements.forEach(el => {
                    const iconWrapper = el.querySelector('.icon-wrapper');
                    if (iconWrapper && !el.classList.contains('folder')) {
                        iconWrapper.innerHTML = `<img src="${iconUrl}" alt="">`;
                    }
                });
            }

            function showStatus(appId, message, type = 'success') {
                const statusEl = document.getElementById(`status-${appId}`);
                statusEl.textContent = message;
                statusEl.className = 'status-message' + (type === 'error' ? ' error' : '');
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
            }

            function deleteTimeCard() {
                const timeCard = document.getElementById('timeCard');
                if (!timeCard) return;

                globalConfig.savedWidgets.push({
                    id: 'timeCard',
                    type: 'time',
                    name: '时间卡片',
                    html: timeCard.outerHTML,
                    timestamp: Date.now()
                });

                timeCard.remove();

                localStorage.setItem('savedWidgets', JSON.stringify(globalConfig.savedWidgets));

                console.log('时间卡片已删除并保存');

                const deletedComponents = JSON.parse(localStorage.getItem('deletedComponents') || '[]');
                if (!deletedComponents.includes('timeCard')) {
                    deletedComponents.push('timeCard');
                    localStorage.setItem('deletedComponents', JSON.stringify(deletedComponents));
                }
            }

            function deleteWeatherCard() {
                const weatherCard = document.getElementById('weatherCard');
                if (!weatherCard) return;

                globalConfig.savedWidgets.push({
                    id: 'weatherCard',
                    type: 'weather',
                    name: '天气卡片',
                    html: weatherCard.outerHTML,
                    timestamp: Date.now()
                });

                weatherCard.remove();

                localStorage.setItem('savedWidgets', JSON.stringify(globalConfig.savedWidgets));

                console.log('天气卡片已删除并保存');
                const deletedComponents = JSON.parse(localStorage.getItem('deletedComponents') || '[]');
                if (!deletedComponents.includes('weatherCard')) {
                    deletedComponents.push('weatherCard');
                    localStorage.setItem('deletedComponents', JSON.stringify(deletedComponents));
                }
            }

            function deleteWidget(widgetElement) {
                if (!widgetElement) return;

                const widgetId = widgetElement.dataset.id;

                globalConfig.savedWidgets.push({
                    id: widgetId,
                    type: 'widget',
                    name: widgetElement.querySelector('.app-label')?.textContent || 'Widget',
                    html: widgetElement.outerHTML,
                    timestamp: Date.now()
                });

                widgetElement.remove();

                localStorage.setItem('savedWidgets', JSON.stringify(globalConfig.savedWidgets));

                console.log(`Widget ${widgetId} 已删除并保存`);
                const deletedComponents = JSON.parse(localStorage.getItem('deletedComponents') || '[]');
                if (!deletedComponents.includes(widgetId)) {
                    deletedComponents.push(widgetId);
                    localStorage.setItem('deletedComponents', JSON.stringify(deletedComponents));
                }
            }

            function createElement(app, grid) {
                const el = document.createElement('div');
                el.className = app.isWidget ? 'widget' : `app-icon${app.isFolder ? ' folder' : ''}`;
                Object.assign(el.dataset, {id: app.id, row: app.row, col: app.col});

                if (app.isWidget) {
                    el.dataset.colspan = app.colspan;
                    el.dataset.rowspan = app.rowspan;
                    el.innerHTML = `
                    <div class="delete-widget-btn" onclick="deleteWidget(this.parentElement)">×</div>
                    <div class="widget-time">HELLO 🎀 19:05 💕💐💖 10/01 周三 💕💕💕</div>
                    <div class="widget-scene">
                        <div class="building" style="left: 10px; width: 50px; height: 40px;"></div>
                        <div class="building" style="left: 70px; width: 60px; height: 55px;"></div>
                        <div class="building" style="left: 140px; width: 45px; height: 35px;"></div>
                        <div style="position: absolute; bottom: 15px; right: 25px; font-size: 50px;">🐱</div>
                    </div>`;
                } else {
                    const customIcon = globalConfig.customIcons[app.id];
                    let content;

                    if (customIcon) {
                        content = `<img src="${customIcon}" alt="${app.label}">`;
                    } else if (app.isFolder) {
                        content = app.icons.slice(0, 9).map(icon => `<div class="folder-mini-icon">${icon}</div>`).join('');
                    } else {
                        content = app.icon;
                    }

                    el.innerHTML = `
                    <div class="icon-wrapper">${content}</div>
                    <div class="app-label">${app.label}</div>
                    ${app.badge ? `<span class="badge">${app.badge}</span>` : ''}`;
                }

                positionElement(el, app.row, app.col, app.colspan, app.rowspan);
                addDragListeners(el, app.clickable);
                grid.appendChild(el);
            }

            function addDragListeners(el, clickable) {
                let lastDragEndTime = 0;
                const startInteraction = (e) => {
                    if (state.isSwipingPage) return;

                    state.hasDragged = false;
                    const touch = getTouch(e);
                    state.dragStart = {x: touch.clientX, y: touch.clientY};

                    state.longPressTimer = setTimeout(() => {
                        state.draggedElement = el;
                        state.isEditMode = true;
                        state.isDragging = true;
                        el.classList.add('dragging');
                        document.body.style.cursor = 'grabbing';
                        showEditHint(true);
                        showDeleteButtons(true);
                    }, 350);
                };

                const endInteraction = () => {
                    clearTimeout(state.longPressTimer);
                    if (state.hasDragged) {
                        lastDragEndTime = Date.now();
                    }
                };

                el.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startInteraction(e);
                });
                el.addEventListener('touchstart', startInteraction, {passive: true});

                el.addEventListener('mouseup', endInteraction);
                el.addEventListener('mouseleave', endInteraction);
                el.addEventListener('touchend', endInteraction);

                if (clickable) {
                    el.addEventListener('click', (e) => {
                        const timeSinceLastDrag = Date.now() - lastDragEndTime;
                        if (!state.hasDragged &&
                            !state.isEditMode &&
                            timeSinceLastDrag > 300 &&
                            el.dataset.id === 'settings') {
                            e.stopPropagation();
                            openSettings();
                        }
                    });
                }
            }

            function isOccupied(pageKey, targetRow, targetCol, draggedId) {
                const apps = state.appLayouts[pageKey];
                for (const app of apps) {
                    if (app.id === draggedId) {
                        continue;
                    }
                    const appColSpan = app.colspan || 1;
                    const appRowSpan = app.rowspan || 1;
                    const inHorizontalRange = targetCol >= app.col && targetCol < (app.col + appColSpan);
                    const inVerticalRange = targetRow >= app.row && targetRow < (app.row + appRowSpan);

                    if (inHorizontalRange && inVerticalRange) {
                        return true;
                    }
                }
                return false;
            }


            function handleMove(e) {
                if (!state.draggedElement) return;

                const touch = getTouch(e);
                const distance = Math.sqrt(
                    Math.pow(touch.clientX - state.dragStart.x, 2) +
                    Math.pow(touch.clientY - state.dragStart.y, 2)
                );

                if (distance > 5 && !state.hasDragged) {
                    state.hasDragged = true;
                    clearTimeout(state.longPressTimer);
                    if (!state.isDragging) {
                        state.isEditMode = true;
                        state.isDragging = true;
                        state.draggedElement.classList.add('dragging');
                        document.body.style.cursor = 'grabbing';
                        showEditHint(true);
                        state.draggedElement.style.transition = 'none';
                    }
                }

                if (!state.isDragging) return;

                if (e.cancelable) e.preventDefault();

                const deltaX = touch.clientX - state.dragStart.x;
                const deltaY = touch.clientY - state.dragStart.y;
                state.draggedElement.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1.08)`;
            }

            function handleEnd(e) {
                clearTimeout(state.longPressTimer);
                document.body.style.cursor = 'default';

                if (state.isDragging && state.draggedElement) {
                    const draggedEl = state.draggedElement;
                    const originalTransition = draggedEl.style.transition;
                    draggedEl.style.transition = 'none';
                    draggedEl.style.transform = '';

                    const grid = draggedEl.parentElement;
                    const gridRect = grid.getBoundingClientRect();

                    const ROW_HEIGHT_PX = 94;
                    const GAP_PX = 14;
                    const DOCK_HEIGHT_PX = 80;

                    const touch = getChangedTouch(e);
                    const dropX = touch.clientX - gridRect.left;
                    const dropY = touch.clientY - gridRect.top;

                    let col = Math.floor(dropX / (gridRect.width / 4));
                    let row = Math.floor(dropY / (ROW_HEIGHT_PX + GAP_PX));

                    const colspan = parseInt(draggedEl.dataset.colspan) || 1;
                    col = Math.max(0, Math.min(col, 4 - colspan));
                    row = Math.max(0, Math.min(row, 6 - 1));

                    const dropYInScreen = touch.clientY;
                    if (dropYInScreen > gridRect.top + gridRect.height - DOCK_HEIGHT_PX) {
                        revertPosition(draggedEl, originalTransition);
                    } else {
                        const pageKey = grid.id === 'grid1' ? 'page1' : 'page2';
                        if (isOccupied(pageKey, row, col, draggedEl.dataset.id)) {
                            revertPosition(draggedEl, originalTransition);
                        } else {
                            updateAndSavePosition(draggedEl, row, col);
                        }
                    }
                }
                finishDrag();
            }


            function finishDrag() {
                if (state.draggedElement) {
                    state.draggedElement.classList.remove('dragging');
                    state.draggedElement.style.transition = '';
                }

                if (!state.hasDragged) {
                    state.isDragging = false;
                    state.draggedElement = null;
                    return;
                }
                setTimeout(() => {
                    state.isEditMode = false;
                    showEditHint(false);
                    showDeleteButtons(false);
                }, 500);

                state.isDragging = false;
                state.draggedElement = null;
                state.hasDragged = false;
            }

            function revertPosition(el, originalTransition = '') {
                const originalRow = parseInt(el.dataset.row);
                const originalCol = parseInt(el.dataset.col);
                const colspan = parseInt(el.dataset.colspan) || 1;
                const rowspan = parseInt(el.dataset.rowspan) || 1;

                el.style.transition = 'all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                positionElement(el, originalRow, originalCol, colspan, rowspan);

                setTimeout(() => {
                    el.style.transition = originalTransition;
                }, 250);
            }


            function updateAndSavePosition(el, newRow, newCol) {
                const appId = el.dataset.id;
                const pageKey = el.parentElement.id === 'grid1' ? 'page1' : 'page2';

                const appData = state.appLayouts[pageKey].find(app => app.id === appId);
                if (appData) {
                    appData.row = newRow;
                    appData.col = newCol;
                }

                el.dataset.row = newRow;
                el.dataset.col = newCol;

                const colspan = parseInt(el.dataset.colspan) || 1;
                const rowspan = parseInt(el.dataset.rowspan) || 1;
                positionElement(el, newRow, newCol, colspan, rowspan);

                saveLayoutToLocalStorage();
                console.log(`已保存 ${appId} 到新位置: (${newRow}, ${newCol})`);
            }

            function saveLayoutToLocalStorage() {
                localStorage.setItem('phoneAppLayouts', JSON.stringify(state.appLayouts));
            }

            function saveCustomIconsToLocalStorage() {
                localStorage.setItem('phoneCustomIcons', JSON.stringify(globalConfig.customIcons));
            }


            function showPage(pageNum) {
                state.currentPage = pageNum;
                pagesWrapper.style.transform = `translateX(-${(pageNum - 1) * 50}%)`;
                document.querySelectorAll('.dot').forEach((dot, i) =>
                    dot.classList.toggle('active', i === pageNum - 1));

                const hint1 = document.getElementById('editHint1');
                const hint2 = document.getElementById('editHint2');

                if (pageNum === 1) {
                    hint1.style.display = 'block';
                    hint2.style.display = 'none';
                } else {
                    hint1.style.display = 'none';
                    hint2.style.display = 'block';
                }
            }


            function handleSwipeStart(e) {
                if (e.target.closest('.contacts-page, .chat-page, .settings-page, .config-page, .beautify-page, .modal-overlay, #codeSandboxModal')) {
                    return;
                }

                if (state.isEditMode || state.isDragging) return;
                const touch = getTouch(e);
                state.swipeStart = {x: touch.clientX, time: Date.now()};
                state.isSwipingPage = true;
                state.initialTransform = -(state.currentPage - 1) * 50;
                pagesWrapper.classList.add('no-transition');
            }


            function handleSwipeMove(e) {
                if (!state.isSwipingPage || state.isEditMode || state.isDragging) return;
                const diff = getTouch(e).clientX - state.swipeStart.x;
                const percentDiff = (diff / screen.offsetWidth) * 50;
                let newTransform = Math.max(-50, Math.min(0, state.initialTransform + percentDiff));
                pagesWrapper.style.transform = `translateX(${newTransform}%)`;
            }

            function handleSwipeEnd(e) {
                if (!state.isSwipingPage || state.isEditMode || state.isDragging) return;
                const diff = getChangedTouch(e).clientX - state.swipeStart.x;
                const velocity = Math.abs(diff) / (Date.now() - state.swipeStart.time);

                pagesWrapper.classList.remove('no-transition');

                if (Math.abs(diff) > 50 || velocity > 0.3) {
                    if (diff > 0 && state.currentPage === 2) showPage(1);
                    else if (diff < 0 && state.currentPage === 1) showPage(2);
                    else showPage(state.currentPage);
                } else {
                    showPage(state.currentPage);
                }

                state.isSwipingPage = false;
            }

            document.addEventListener('touchmove', handleMove, {passive: false});
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchend', (e) => handleEnd(e));
            document.addEventListener('mouseup', (e) => handleEnd(e));

            screen.addEventListener('touchstart', handleSwipeStart, {passive: true});
            screen.addEventListener('mousedown', handleSwipeStart);
            screen.addEventListener('touchmove', handleSwipeMove, {passive: true});
            screen.addEventListener('mousemove', handleSwipeMove);
            screen.addEventListener('touchend', handleSwipeEnd);
            screen.addEventListener('mouseup', handleSwipeEnd);
            screen.addEventListener('mouseleave', handleSwipeEnd);

            screen.addEventListener('click', (e) => {
                if (e.target.closest('.chat-page, .contacts-page, .settings-page, .config-page, .beautify-page, .modal-overlay')) {
                    return;
                }

                if (!e.target.closest('.app-icon') &&
                    !e.target.closest('.widget') &&
                    !e.target.closest('.time-card') &&
                    !e.target.closest('.weather-card') &&
                    !e.target.closest('[class*="delete-"]')) {
                    exitEditMode();
                }
            });


            function initializeLayout() {
                const savedWallpaper = localStorage.getItem('phoneWallpaper');
                if (savedWallpaper) {
                    applyWallpaper(savedWallpaper);
                }
                const savedDockIcons = localStorage.getItem('phoneDockIcons');
                if (savedDockIcons) {
                    try {
                        globalConfig.dockIcons = JSON.parse(savedDockIcons);
                        console.log('成功从 LocalStorage 加载Dock图标');

                        document.querySelectorAll('.dock-icon').forEach((dockIcon, index) => {
                            const icon = globalConfig.dockIcons[index];
                            if (icon && (icon.startsWith('http') || icon.startsWith('data:'))) {
                                dockIcon.innerHTML = `<img src="${icon}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 14px;" alt="">`;
                            } else if (icon) {
                                dockIcon.textContent = icon;
                            }
                        });
                    } catch (e) {
                        console.error('解析 Dock 图标失败', e);
                    }
                }
                const savedIcons = localStorage.getItem('phoneCustomIcons');
                if (savedIcons) {
                    try {
                        globalConfig.customIcons = JSON.parse(savedIcons);
                        console.log('成功从 LocalStorage 加载自定义图标');
                    } catch (e) {
                        console.error('解析 LocalStorage 图标数据失败，使用默认图标', e);
                        globalConfig.customIcons = {};
                    }
                }

                const savedWidgets = localStorage.getItem('savedWidgets');
                if (savedWidgets) {
                    try {
                        globalConfig.savedWidgets = JSON.parse(savedWidgets);
                        console.log('成功从 LocalStorage 加载已删除组件');
                    } catch (e) {
                        console.error('解析 LocalStorage 已删除组件失败', e);
                        globalConfig.savedWidgets = [];
                    }
                }
                const deletedComponents = JSON.parse(localStorage.getItem('deletedComponents') || '[]');
                console.log('已删除的组件:', deletedComponents);

                const savedLayouts = localStorage.getItem('phoneAppLayouts');
                if (savedLayouts) {
                    try {
                        state.appLayouts = JSON.parse(savedLayouts);
                        console.log('成功从 LocalStorage 加载布局');
                    } catch (e) {
                        console.error('解析 LocalStorage 布局失败，使用默认布局', e);
                    }
                }

                [['grid1', state.appLayouts.page1], ['grid2', state.appLayouts.page2]].forEach(([id, apps]) => {
                    const grid = document.getElementById(id);
                    grid.innerHTML = '';
                    apps.forEach(app => {
                        if (app.isWidget && deletedComponents.includes(app.id)) {
                            console.log(`跳过已删除的组件: ${app.id}`);
                            return;
                        }
                        createElement(app, grid);
                    });
                });
                if (deletedComponents.includes('timeCard')) {
                    const timeCard = document.getElementById('timeCard');
                    if (timeCard) {
                        timeCard.remove();
                        console.log('时间卡片已从页面移除(根据删除标记)');
                    }
                }

                if (deletedComponents.includes('weatherCard')) {
                    const weatherCard = document.getElementById('weatherCard');
                    if (weatherCard) {
                        weatherCard.remove();
                        console.log('天气卡片已从页面移除(根据删除标记)');
                    }
                }
                loadSavedMoodAndWeather();
            }

            document.getElementById('chatInput').addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();

                    addMessageToList();
                }
            });

            function openAvatarActions() {
                document.getElementById('avatarActionSheet').classList.add('show');
            }

            function closeAvatarActions() {
                document.getElementById('avatarActionSheet').classList.remove('show');
            }

            function triggerFileUpload() {
                document.getElementById('avatar-input').click();
                closeAvatarActions();
            }

            function promptForUrl() {
                const url = prompt("请输入图片URL:", "https://");

                if (url) {
                    const img = new Image();
                    img.src = url;
                    img.onload = function () {
                        document.getElementById('avatar-preview').src = url;
                        console.log("URL图片加载成功！");
                    };
                    img.onerror = function () {
                        alert("无法加载该URL的图片，请检查链接是否正确。");
                        console.error("URL图片加载失败:", url);
                    };
                }

                closeAvatarActions();
            }

            /* --- 用这个最终版本的 openChat 函数替换你现有的 --- */

            /* --- 动画修复版 openChat 函数 --- */
            function openChat(contact) {
                currentChatContact = contact;

                const chatPage = document.getElementById('chatPage');
                const contactNameEl = document.getElementById('chatContactName');
                const messagesEl = document.getElementById('chatMessages');

                contactNameEl.textContent = contact.name;
                messagesEl.innerHTML = '';

                // --- ↓↓↓ 关键改动在这里 ↓↓↓ ---

                // 1. **立即**让页面可见，但保持在屏幕外。
                //    (这一步是为了解决可能存在的 display:none 问题)
                //    如果你的 .chat-page 默认就是 display:flex，这行代码可以省略，但加上更保险。
                //    chatPage.style.display = 'flex'; // 我们先不加这行，因为你的CSS里似乎默认就是flex

                // 2. 清除上次可能留下的行内样式，确保 transition 生效
                chatPage.style.transform = '';

                // 3. 使用 requestAnimationFrame 来确保动画在下一帧触发
                requestAnimationFrame(() => {
                    chatPage.classList.add('show');
                });

                // --- ↑↑↑ 关键改动结束 ↑↑↑ ---

                const chatHistory = JSON.parse(localStorage.getItem('phoneChatHistory') || '{}');
                const contactMessages = chatHistory[contact.id] || [];

                if (contactMessages.length === 0) {
                    const messageRow = document.createElement('div');
                    messageRow.className = 'message-row received';
                    const welcomeBubble = createMessageBubble(`你已和 ${contact.name} 开始聊天`);
                    messageRow.appendChild(welcomeBubble);
                    messagesEl.appendChild(messageRow);
                } else {
                    contactMessages.forEach((message, index) => {
                        const messageRow = _createMessageDOM(contact.id, message, index);
                        messagesEl.appendChild(messageRow);
                    });
                }

                // 这句 classList.add 已经被移到上面 requestAnimationFrame 的回调里了

                setTimeout(() => {
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }, 50);
            }


            function closeChat() {
                const chatPage = document.getElementById('chatPage');
                chatPage.classList.remove('show');
            }

            async function callApi(messages) {
                if (globalConfig.activeApiConfig === null || !globalConfig.apiConfigs[globalConfig.activeApiConfig]) {
                    return {success: false, message: '请先在“设置”中配置并选择一个有效的API。'};
                }
                const config = globalConfig.apiConfigs[globalConfig.activeApiConfig];

                const requestBody = {
                    model: config.model,
                    messages: messages,
                };

                try {
                    const response = await fetch(`${config.url}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.key}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({message: '无法解析API错误信息'}));
                        throw new Error(`API 请求失败，状态码: ${response.status} - ${errorData.error ? errorData.error.message : response.statusText}`);
                    }

                    const data = await response.json();

                    const replyContent = data.choices[0]?.message?.content;

                    if (!replyContent) {
                        throw new Error('API返回的数据格式不正确，未能找到回复内容。');
                    }

                    return {success: true, message: replyContent.trim()};

                } catch (error) {
                    console.error('调用API时出错:', error);
                    return {success: false, message: `网络或API错误: ${error.message}`};
                }
            }


            function addMessageToList() {
                const inputEl = document.getElementById('chatInput');
                const messagesEl = document.getElementById('chatMessages');
                const messageText = inputEl.value.trim();

                if (!messageText || !currentChatContact) return;

                const newIndex = saveMessage(currentChatContact.id, {sender: 'user', text: messageText});

                const messageRow = _createMessageDOM(currentChatContact.id, {
                    sender: 'user',
                    text: messageText
                }, newIndex);
                messagesEl.appendChild(messageRow);

                renderContacts(contactsData);
                inputEl.value = '';
                messagesEl.scrollTop = messagesEl.scrollHeight;
                inputEl.focus();
            }

            async function getAiReply() {
                if (!currentChatContact) return;

                const messagesEl = document.getElementById('chatMessages');
                const getReplyBtn = document.getElementById('getReplyBtn');
                const chatInput = document.getElementById('chatInput');

                getReplyBtn.disabled = true;
                chatInput.disabled = true;

                const chatHistory = JSON.parse(localStorage.getItem('phoneChatHistory') || '{}');
                const historyMessages = chatHistory[currentChatContact.id] || [];

                const hasUserMessages = historyMessages.some(msg => msg.sender === 'user');
                if (!hasUserMessages) {
                    console.log("没有用户消息，不请求AI回复。");
                    getReplyBtn.disabled = false;
                    chatInput.disabled = false;
                    return;
                }

                const persona = (currentChatContact.status && currentChatContact.status.trim() !== '')
                    ? currentChatContact.status
                    : '你是一个乐于助人的助手，请用友好和简洁的方式回答问题。';

                const apiMessages = [{role: 'system', content: persona}];
                historyMessages.forEach(msg => {
                    apiMessages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.text
                    });
                });

                const thinkingBubble = createMessageBubble('...', 'received');
                messagesEl.appendChild(thinkingBubble);
                messagesEl.scrollTop = messagesEl.scrollHeight;

                const result = await callApi(apiMessages);
                thinkingBubble.remove();

                let responseText, newIndex;
                if (result.success) {
                    responseText = result.message;
                    newIndex = saveMessage(currentChatContact.id, {sender: 'contact', text: responseText});
                } else {
                    responseText = `出错了: ${result.message}`;
                    newIndex = saveMessage(currentChatContact.id, {sender: 'contact', text: `[错误] ${responseText}`});
                }

                const messageRow = _createMessageDOM(currentChatContact.id, {
                    sender: 'contact',
                    text: responseText
                }, newIndex);
                if (!result.success) {
                    messageRow.querySelector('.chat-bubble').style.backgroundColor = '#ffebee';
                    messageRow.querySelector('.chat-bubble').style.color = '#c62828';
                }
                messagesEl.appendChild(messageRow);


                renderContacts(contactsData);
                messagesEl.scrollTop = messagesEl.scrollHeight;
                getReplyBtn.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }


            function saveMessage(contactId, message) {
                const chatHistory = JSON.parse(localStorage.getItem('phoneChatHistory') || '{}');
                if (!chatHistory[contactId]) {
                    chatHistory[contactId] = [];
                }

                const messageToSave = {
                    sender: message.sender,
                    text: message.text
                };

                chatHistory[contactId].push(messageToSave);
                localStorage.setItem('phoneChatHistory', JSON.stringify(chatHistory));

                return chatHistory[contactId].length - 1;
            }


            function editCurrentContact() {
                if (!currentChatContact) return;

                const page = document.getElementById('characterCardModal');
                const nameInput = document.getElementById('char-name');
                const personaTextarea = document.getElementById('char-persona');
                const idSpan = document.getElementById('char-id');
                const avatarPreview = document.getElementById('avatar-preview');

                nameInput.value = currentChatContact.name;
                personaTextarea.value = currentChatContact.status;
                idSpan.textContent = currentChatContact.id;

                const isUrl = currentChatContact.avatar.startsWith('http') || currentChatContact.avatar.startsWith('data:');
                if (isUrl) {
                    avatarPreview.src = currentChatContact.avatar;
                } else {
                    avatarPreview.src = '';
                }

                page.classList.add('show');
            }

            function showSuccessModal(title = '操作成功', message = '你的设置已保存。', duration = 1500) {
                const modal = document.getElementById('successModal');
                const modalTitle = document.getElementById('successModalTitle');
                const modalMessage = document.getElementById('successModalMessage');

                modalTitle.textContent = title;
                modalMessage.textContent = message;

                modal.style.display = 'flex';

                setTimeout(() => modal.classList.add('show'), 10);

                setTimeout(() => {
                    modal.classList.remove('show');
                    setTimeout(() => modal.style.display = 'none', 300);
                }, duration);
            }

            function deleteApiConfig(index) {
                const configToDelete = globalConfig.apiConfigs[index];
                if (!configToDelete) return;

                if (confirm(`你确定要删除配置 "${configToDelete.name}" 吗？`)) {
                    globalConfig.apiConfigs.splice(index, 1);

                    if (globalConfig.activeApiConfig === index) {
                        globalConfig.activeApiConfig = null;
                        clearApiForm();
                    } else if (globalConfig.activeApiConfig > index) {
                        globalConfig.activeApiConfig--;
                    }

                    console.log(`配置 "${configToDelete.name}" 已删除。`);

                    saveGlobalConfig();
                    renderApiConfigs();

                    showSuccessModal('删除成功', `配置 "${configToDelete.name}" 已被移除。`);
                }
            }

            function saveGlobalConfig() {
                try {
                    const configToSave = {
                        apiConfigs: globalConfig.apiConfigs,
                        activeApiConfig: globalConfig.activeApiConfig,
                    };
                    localStorage.setItem('phoneGlobalConfig', JSON.stringify(configToSave));
                } catch (e) {
                    console.error('保存全局配置到 localStorage 失败:', e);
                }
            }

            function loadGlobalConfig() {
                try {
                    const savedConfig = localStorage.getItem('phoneGlobalConfig');
                    if (savedConfig) {
                        const parsedConfig = JSON.parse(savedConfig);
                        Object.assign(globalConfig, parsedConfig);
                        console.log('成功从 localStorage 加载API配置。');
                    }
                } catch (e) {
                    console.error('从 localStorage 加载API配置失败:', e);
                }
            }

            function openChatSettings() {
                document.getElementById('chatSettingsPage').classList.add('show');
            }

            function closeChatSettings() {
                document.getElementById('chatSettingsPage').classList.remove('show');
            }

            function clearCurrentChatHistory() {
                if (!currentChatContact) return; // 安全检查，确保当前有聊天对象

                // 弹出确认框，防止用户误操作
                if (confirm(`确定要清空与 "${currentChatContact.name}" 的所有聊天记录吗？`)) {
                    // 从 localStorage 读取聊天记录
                    const chatHistory = JSON.parse(localStorage.getItem('phoneChatHistory') || '{}');

                    // 如果存在当前联系人的记录，就删除它
                    if (chatHistory[currentChatContact.id]) {
                        delete chatHistory[currentChatContact.id];
                        // 将修改后的数据存回 localStorage
                        localStorage.setItem('phoneChatHistory', JSON.stringify(chatHistory));

                        // 重新加载聊天界面，使其显示为空
                        openChat(currentChatContact);

                        // 关闭设置页并显示成功提示
                        closeChatSettings();
                        showSuccessModal('操作成功', '聊天记录已清空。');
                    }
                }
            }


            /* --- 复制并粘贴这段代码 --- */
            function applyCodeScrollSetting(isEnabled) {
                if (isEnabled) {
                    document.body.classList.add('code-scrolling-enabled');
                } else {
                    document.body.classList.remove('code-scrolling-enabled');
                }
            }

            /* ------------------------- */


            // ========== 开始：这是你需要粘贴的新JS代码 ==========

            /**
             * 应用聊天背景图的核心函数
             * @param {string} imageUrl - 图片的URL或Base64数据。如果为空字符串，则恢复默认背景。
             */
            function applyChatBackground(imageUrl) {
                const chatPage = document.getElementById('chatPage');
                if (imageUrl) {
                    // 设置背景图片
                    chatPage.style.backgroundImage = `url('${imageUrl}')`;
                    chatPage.style.backgroundSize = 'cover';
                    chatPage.style.backgroundPosition = 'center';
                    localStorage.setItem('chatBackground', imageUrl);
                    showChatBgStatus('背景已应用');
                } else {
                    // 恢复默认背景
                    chatPage.style.backgroundImage = '';
                    localStorage.removeItem('chatBackground');
                    showSuccessModal('操作成功', '已恢复为默认背景。');
                }
            }

            /**
             * 从本地文件上传处理函数
             * @param {Event} event - 文件输入框的change事件对象
             */
            function handleChatBgUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // 使用FileReader将图片转为Base64，以便保存和预览
                const reader = new FileReader();
                reader.onload = (e) => {
                    applyChatBackground(e.target.result);
                };
                reader.onerror = () => {
                    showChatBgStatus('读取文件失败', 'error');
                };
                reader.readAsDataURL(file);
            }

            /**
             * 切换URL输入框的显示/隐藏
             */
            function toggleChatBgUrlInput() {
                const urlBox = document.getElementById('chat-bg-url-box');
                urlBox.classList.toggle('show');
            }

            /**
             * 从URL输入框应用背景图
             */
            function applyChatBgFromUrl() {
                const urlInput = document.getElementById('chat-bg-url-input');
                const url = urlInput.value.trim();
                if (url) {
                    applyChatBackground(url);
                    urlInput.value = '';
                    toggleChatBgUrlInput(); // 应用后自动隐藏输入框
                } else {
                    showChatBgStatus('请输入有效的URL', 'error');
                }
            }

            /**
             * 在UI上显示状态消息
             * @param {string} message - 要显示的消息
             * @param {string} type - 消息类型 ('success' 或 'error')
             */
            function showChatBgStatus(message, type = 'success') {
                const statusEl = document.getElementById('chat-bg-status');
                statusEl.textContent = message;
                statusEl.className = 'status-message' + (type === 'error' ? ' error' : '');
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
            }

            /**
             * 加载已保存的聊天背景图 (在应用初始化时调用)
             */
            function loadChatBackground() {
                const savedBg = localStorage.getItem('chatBackground');
                if (savedBg) {
                    applyChatBackground(savedBg);
                }
            }

            /* ========== 开始：粘贴这段全新的JS代码块 ========== */
            function applyChatStyle(style) {
                const chatPage = document.getElementById('chatPage');
                const selector = document.getElementById('messageStyleSelector');

                if (style === 'simple') {
                    chatPage.classList.add('simple-style');
                } else {
                    chatPage.classList.remove('simple-style');
                }

                // 更新UI选择器状态
                if (selector) {
                    selector.querySelectorAll('.segmented-option').forEach(opt => {
                        opt.classList.toggle('active', opt.dataset.style === style);
                    });
                }

                // 保存选择
                localStorage.setItem('chatMessageStyle', style);
            }


            function setupStyleSelector() {
                const selector = document.getElementById('messageStyleSelector');
                if (selector) {
                    selector.addEventListener('click', (event) => {
                        const target = event.target.closest('.segmented-option');
                        if (target && !target.classList.contains('active')) {
                            const newStyle = target.dataset.style;
                            applyChatStyle(newStyle);
                        }
                    });
                }
            }

            function applyFullscreenSetting(isEnabled) {
                if (isEnabled) {
                    document.body.classList.add('fullscreen-enabled');
                } else {
                    document.body.classList.remove('fullscreen-enabled');
                }
            }

            // 2. 从 localStorage 读取保存的设置
            const savedFullscreenSetting = localStorage.getItem('fullscreenEnabled') === 'true';
            // 3. 根据保存的设置，设置开关的初始状态
            fullscreenToggle.checked = savedFullscreenSetting;
            // 4. 根据保存的设置，应用初始样式
            applyFullscreenSetting(savedFullscreenSetting);
            // 5. 为开关添加事件监听器
            fullscreenToggle.addEventListener('change', function () {
                const isEnabled = this.checked;
                // 当用户点击开关时，应用样式
                applyFullscreenSetting(isEnabled);
                // 并将选择保存到 localStorage
                localStorage.setItem('fullscreenEnabled', isEnabled);
            });

            /* ========== 开始：用这段全新的代码替换旧的 setupAttachmentMenu 函数 ========== */

            function setupAttachmentMenu() {
                // 1. 获取所有相关的 DOM 元素
                const showMenuBtn = document.getElementById('showAttachmentMenuBtn');
                const menu = document.getElementById('attachmentMenu');
                const fileInput = document.getElementById('fileInput');
                const imageInput = document.getElementById('imageInput'); // 图片上传暂时只做前端预览
                const uploadFileBtn = document.getElementById('uploadFileBtn');
                const uploadImageBtn = document.getElementById('uploadImageBtn');

                // 2. 点击“+”按钮时，切换菜单的显示/隐藏
                showMenuBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    menu.classList.toggle('show');
                });

                // 3. 点击“上传文件”菜单项时，触发隐藏的文件选择框
                uploadFileBtn.addEventListener('click', () => {
                    fileInput.click();
                    menu.classList.remove('show');
                });

                // 4. 点击“上传图片”菜单项（暂时只做预览，不上传）
                uploadImageBtn.addEventListener('click', () => {
                    imageInput.click();
                    menu.classList.remove('show');
                });

                // 5. 【核心改造】当用户选择了文件后，上传文件并获取AI回复
                fileInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    // a. 先在界面上显示“文件已发送”
                    const userMessageText = `📎 文件已发送: ${file.name}`;
                    simulateSendingMessage(userMessageText);

                    // b. 显示一个“AI正在思考”的提示
                    const messagesEl = document.getElementById('chatMessages');
                    const thinkingBubble = _createMessageDOM(currentChatContact.id, {
                        sender: 'contact',
                        text: '正在读取和分析文件...'
                    }, -1);
                    messagesEl.appendChild(thinkingBubble);
                    messagesEl.scrollTop = messagesEl.scrollHeight;

                    try {
                        // c. 调用函数将文件发送到我们的后端（Edge Function）
                        const aiResponse = await uploadFileAndGetAiResponse(file);

                        // d. 移除思考提示，显示AI的真实回复
                        thinkingBubble.remove();
                        const newIndex = saveMessage(currentChatContact.id, {sender: 'contact', text: aiResponse});
                        const messageRow = _createMessageDOM(currentChatContact.id, {
                            sender: 'contact',
                            text: aiResponse
                        }, newIndex);
                        messagesEl.appendChild(messageRow);

                    } catch (error) {
                        // e. 如果出错，显示错误信息
                        thinkingBubble.remove();
                        const errorText = `处理文件失败: ${error.message}`;
                        const newIndex = saveMessage(currentChatContact.id, {sender: 'contact', text: errorText});
                        const messageRow = _createMessageDOM(currentChatContact.id, {
                            sender: 'contact',
                            text: errorText
                        }, newIndex);
                        messageRow.querySelector('.chat-bubble').style.backgroundColor = '#ffebee';
                        messageRow.querySelector('.chat-bubble').style.color = '#c62828';
                        messagesEl.appendChild(messageRow);
                    } finally {
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                        event.target.value = ''; // 重置input
                    }
                });

                // 图片选择的逻辑保持不变，仅作本地预览
                imageInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const messageText = `<img src="${e.target.result}" style="max-width: 150px; border-radius: 10px;" alt="${file.name}">`;
                            simulateSendingMessage(messageText);
                            setTimeout(() => {
                                const reply = "好可爱的图片！不过我暂时还无法深入分析图片内容哦。";
                                const newIndex = saveMessage(currentChatContact.id, {sender: 'contact', text: reply});
                                const messageRow = _createMessageDOM(currentChatContact.id, {
                                    sender: 'contact',
                                    text: reply
                                }, newIndex);
                                document.getElementById('chatMessages').appendChild(messageRow);
                                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                            }, 1500);

                        }
                        reader.readAsDataURL(file);
                    }
                    event.target.value = '';
                });

                // 7. 关闭菜单的逻辑
                document.addEventListener('click', () => {
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                    }
                });
                menu.addEventListener('click', (event) => event.stopPropagation());
            }

            /**
             * 【核心函数】上传文件到后端并等待AI响应
             * @param {File} file 用户选择的文件对象
             * @returns {Promise<string>} AI的回复文本
             */
            async function uploadFileAndGetAiResponse(file) {
                // 假设你的 Supabase Edge Function 地址是这个
                // 你需要先创建这个 Function，见第2步
                const functionUrl = `${globalConfig.database.supabaseUrl}/functions/v1/analyze-file`;
                const supabaseKey = globalConfig.database.supabaseKey;

                if (!functionUrl || !supabaseKey) {
                    throw new Error("Supabase 配置不完整，请在设置中检查 URL 和 Key。");
                }

                // 使用 FormData 来包装文件，适合文件上传
                const formData = new FormData();
                formData.append('file', file);

                // 获取当前聊天记录作为上下文
                const chatHistory = JSON.parse(localStorage.getItem('phoneChatHistory') || '{}');
                const historyMessages = chatHistory[currentChatContact.id] || [];

                // 将历史记录和角色设定一起发送给后端
                formData.append('chatHistory', JSON.stringify(historyMessages));
                formData.append('persona', currentChatContact.status || '你是一个乐于助人的AI助手');

                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${supabaseKey}`
                        // 注意：当使用 FormData 时，浏览器会自动设置 Content-Type，不要手动设置
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '服务器返回错误');
                }

                const result = await response.json();
                return result.reply;
            }

            /* ========== 结束：替换代码 ========== */


            // 创建一个辅助函数来模拟发送消息，避免代码重复
            function simulateSendingMessage(messageText) {
                const messagesEl = document.getElementById('chatMessages');
                if (!messageText || !currentChatContact) return;

                // 保存消息记录
                const newIndex = saveMessage(currentChatContact.id, {sender: 'user', text: messageText});

                // 创建并显示消息 DOM
                const messageRow = _createMessageDOM(currentChatContact.id, {
                    sender: 'user',
                    text: messageText
                }, newIndex);
                messagesEl.appendChild(messageRow);

                // 更新联系人列表的最后消息并滚动到底部
                renderContacts(contactsData);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            /* ========== 结束：粘贴 JavaScript 代码块 ========== */


            function initializeApp() {
                setupAttachmentMenu();
                const fullscreenToggle = document.getElementById('fullscreenToggle');
                setupStyleSelector();
                applyChatStyle(localStorage.getItem('chatMessageStyle') || 'bubble');
                loadChatBackground();
                loadGlobalConfig();
                /* --- 复制并粘贴这段代码到 initializeApp 函数内部的开头 --- */
                // ===== 代码框滚动条功能初始化 =====
                const codeScrollToggle = document.getElementById('codeScrollToggle');

                // 从 localStorage 读取保存的设置，'true' (字符串) 表示开启
                const savedScrollSetting = localStorage.getItem('codeScrollEnabled') === 'true';

                // 根据保存的设置，设置开关的初始状态
                codeScrollToggle.checked = savedScrollSetting;

                // 根据保存的设置，应用初始样式
                applyCodeScrollSetting(savedScrollSetting);

                // 为开关添加事件监听，当用户点击时触发
                codeScrollToggle.addEventListener('change', function () {
                    // 根据开关的当前状态 (开启/关闭) 来应用样式
                    applyCodeScrollSetting(this.checked);
                    // 将新的设置保存到 localStorage，以便下次打开时记住
                    localStorage.setItem('codeScrollEnabled', this.checked);
                });

                // ========== 开始：将这段代码添加到 initializeApp 函数末尾 ==========
                // 初始化消息操作菜单的按钮事件
                const deleteMessageBtn = document.getElementById('deleteMessageBtn');
                deleteMessageBtn.addEventListener('click', () => {
                    // 从按钮的 dataset 中读取之前存入的消息信息
                    const {contactId, index} = deleteMessageBtn.dataset;
                    if (contactId !== undefined && index !== undefined) {
                        // 调用删除函数，注意将 index 转为数字
                        deleteMessage(contactId, parseInt(index, 10));
                    }
                    // 操作完成后隐藏菜单
                    hideMessageActionSheet();
                });

                initializeLayout();

                renderApiConfigs();

                if (globalConfig.activeApiConfig !== null && globalConfig.apiConfigs[globalConfig.activeApiConfig]) {
                    applyApiConfig(globalConfig.activeApiConfig);
                }

                console.log('%c🎉 可爱手机界面已加载！配置已恢复！', 'color: #667eea; font-size: 16px; font-weight: bold;');
                console.log('%c💡 使用提示:', 'color: #4facfe; font-size: 14px; font-weight: bold;');
                console.log('1. 配置数据库后，使用 dbAPI.saveData() 和 dbAPI.getData()');
                console.log('2. 配置云存储后，文件上传自动使用 storageAPI.uploadFile()');
                console.log('3. 所有配置保存后自动初始化，无需手动调用');
            }

            initializeApp();

            console.log('%c🎉 可爱手机界面已加载！', 'color: #667eea; font-size: 16px; font-weight: bold;');
            console.log('%c💡 使用提示:', 'color: #4facfe; font-size: 14px; font-weight: bold;');
            console.log('1. 配置数据库后，使用 dbAPI.saveData() 和 dbAPI.getData()');
            console.log('2. 配置云存储后，文件上传自动使用 storageAPI.uploadFile()');
            console.log('3. 所有配置保存后自动初始化，无需手动调用');
        </script>


</body>
</html>